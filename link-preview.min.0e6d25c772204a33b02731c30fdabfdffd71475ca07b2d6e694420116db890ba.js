document.addEventListener("DOMContentLoaded",function(){console.log("Link preview script loaded");const t=document.createElement("div");t.className="link-preview floating",t.style.display="none",document.body.appendChild(t);const e=new Map;function s(e){const t=e.match(/[^.!?]+[.!?]+/g)||[],n=t.slice(0,2).join(" ");return t.length>2?n+"...":n}async function o(t){if(e.has(t))return e.get(t);try{const r=new URL(t,window.location.origin),o=await fetch(r.pathname);if(!o.ok)throw new Error("Network response was not ok");const c=await o.text(),l=new DOMParser,n=l.parseFromString(c,"text/html");if(t.includes("/glossary/")&&t.includes("#")){const i=decodeURIComponent(t.split("#")[1]);console.log("Looking for glossary term:",i);let o=n.querySelector(`h3#${i}`);if(!o){const e=n.getElementsByTagName("h3");for(const t of e)if(t.textContent.trim()===decodeURIComponent(i)){o=t;break}}if(o){console.log("Found term heading:",o.textContent);let n="",i=o.nextElementSibling;for(;i&&i.tagName!=="H3";)n+=" "+i.textContent,i=i.nextElementSibling;const a=o.textContent.trim().replace(/ #$/,"");n=s(n.trim()),console.log("Term preview data:",{title:a,description:n});const r={title:a,description:n};return e.set(t,r),r}console.log("Term heading not found for ID:",i)}const a=i(n);return e.set(t,a),a}catch(e){return console.error("Error fetching content:",e),null}}function i(e){const n=e.querySelector("h1")?.textContent||"",s=e.querySelector('meta[name="description"]')?.content||"";let t="";if(t=e.querySelector('meta[property="og:image"]')?.content||"",!t){const n=e.querySelector(".pageCover img, .book-post_cover img");n&&(t=n.src||n.getAttribute("data-src")||"")}return t&&!t.startsWith("http")&&(t=new URL(t,window.location.origin).href),{title:n,description:s,coverImg:t}}function a(e,t){const s=t&&t.includes("/glossary/")&&t.includes("#");if(s)return`
                <div class="preview-content glossary">
                    <h4>${e.title||""}</h4>
                    <p>${e.description||""}</p>
                </div>
            `;const n=!!e.coverImg;return`
            <div class="preview-content page${n?"":" no-image"}">
                ${n?`<img class="preview-image" src="${e.coverImg}" alt="${e.title}" loading="lazy">`:""}
                <div class="preview-text">
                    <h4>${e.title||""}</h4>
                    <p>${e.description||""}</p>
                </div>
            </div>
        `}function c(e,t){const n=15,a=t.target.getBoundingClientRect(),s=e.getBoundingClientRect();let o=t.clientX-s.width/2,i=a.bottom+n;o=Math.max(n,Math.min(o,window.innerWidth-s.width-n)),i+s.height>window.innerHeight-n&&(i=a.top-s.height-n),e.style.left=`${o}px`,e.style.top=`${i}px`}function n(e){if(!e)return!1;const t=e.getAttribute("href");if(!t)return!1;if(t.startsWith("#"))return!1;if(t.startsWith("http"))return!1;if(e.closest(".book-menu"))return!1;const n=t.includes("/glossary/")&&t.includes("#");return!!n||e.host===window.location.host}async function r(e){const i=e.target.closest("a");if(!n(i))return;const s=i.getAttribute("href"),r=window.matchMedia("(hover: none) and (pointer: coarse)").matches;if(r){e.preventDefault();const t=document.querySelector(".link-preview.floating");if(t&&(t.remove(),t.dataset.href===s)){window.location.href=s;return}}const t=document.createElement("div");if(t.className="link-preview floating",t.dataset.href=s,!r){const e=i.getBoundingClientRect(),s=250,n=window.innerHeight-e.bottom,o=e.top;n>=s||n>=o?t.style.top=`${e.bottom+10}px`:t.style.bottom=`${window.innerHeight-e.top+10}px`,t.style.left=`${e.left+e.width/2}px`,t.style.transform="translateX(-50%)"}t.innerHTML='<div class="preview-content"><div style="text-align: center">Загрузка...</div></div>',document.body.appendChild(t),r&&t.classList.add("active"),o(s).then(e=>{if(!e){t.remove();return}const n=a(e,s);t.innerHTML=n})}window.matchMedia("(hover: none) and (pointer: coarse)").matches&&document.addEventListener("touchstart",e=>{const t=document.querySelector(".link-preview.floating");if(!t)return;const n=!t.contains(e.target),s=!e.target.closest(`a[href="${t.dataset.href}"]`);n&&s&&t.remove()}),document.addEventListener("mouseover",e=>{const t=e.target.closest("a");n(t)&&r(e)}),document.addEventListener("mouseout",e=>{const n=e.target.closest("a"),t=document.querySelector(".link-preview.floating");n&&t&&t.remove()})})