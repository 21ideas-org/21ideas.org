<!doctype html><html lang=en dir=ltr><head><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel=stylesheet><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  This article by Dmitry Laptev was published in his Medium blog.
Contribute.



First, we discuss why we need it (part 0) and describe an idea of payment channels and Lightning Network (part 1). Then we introduce required building blocks (part 2) and see how these blocks can be used to create payment channels (part 3). We then finally build Lightning Network, discuss its properties (part 4), and sum it all up (part 5)."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta name=lightning content="21ideas@getalby.com"><meta property="og:title" content="Lightning Network Explained"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://21ideas.org/en/lightning-network-explained/"><meta property="og:image" content="https://21ideas.org/img/mln-850.jpeg"><title>Lightning Network Explained | 21ideas</title>
<link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon media="(prefers-color-scheme: dark)" sizes=180x180 href=/apple-touch-icon-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=32x32 href=/favicon-32x32-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=16x16 href=/favicon-16x16-dark.png><link rel=alternate hreflang=ru-RU href=https://21ideas.org/mekhanizm-raboty-lightning/ title="Механизм работы Lightning Network"><link rel=stylesheet href=/book.min.a88fda41628a86b0aa4a3caa9c8ab466ee8e01a433898186e506a93fb98f1884.css integrity="sha256-qI/aQWKKhrCqSjyqnIq0Zu6OAaQziYGG5QapP7mPGIQ=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.d6bc52f60174ba6dedd819f430e20fafba72374b0fb89a05c809afcea190127c.js integrity="sha256-1rxS9gF0um3t2Bn0MOIPr7pyN0sPuJoFyAmvzqGQEnw=" crossorigin=anonymous></script><script type=text/javascript src=https://unpkg.com/zapthreads@0.5.2/dist/zapthreads.iife.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/en/><picture><source srcset=/svg/logo_white.svg media="(prefers-color-scheme: dark)"><img src=/svg/logo_black.svg alt=Logo>
</picture><span>21ideas</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul><li><a href=https://21ideas.org/mekhanizm-raboty-lightning/>Русский</a></li></ul></li></ul><ul><li><input type=checkbox id=section-2c1fc68ff68c3e454d055a4d37a4816d class=toggle>
<label for=section-2c1fc68ff68c3e454d055a4d37a4816d class="flex justify-between"><a role=button>Start</a></label><ul><li><a href=/en/start/start/>Bitcoin Basics</a></li><li><a href=/en/start/guide/>Using Bitcoin</a></li><li><a href=/en/shitcoin-gambling-games/>Don’t Play Shitcoin Gambling Games</a></li></ul></li><li><input type=checkbox id=section-0e947b637002f54ca330500896114bfb class=toggle checked>
<label for=section-0e947b637002f54ca330500896114bfb class="flex justify-between"><a href=/en/theory/>Theory</a></label><ul><li><input type=checkbox id=section-c8c88ad6975c3c08b99f7a6aaa8233c7 class=toggle>
<label for=section-c8c88ad6975c3c08b99f7a6aaa8233c7 class="flex justify-between"><a href=/en/economics/>Economics</a></label><ul><li><input type=checkbox id=section-042039620ae77f503533b4129302aa25 class=toggle>
<label for=section-042039620ae77f503533b4129302aa25 class="flex justify-between"><a href=/en/gradually-then-suddenly/>Gradually, Then Suddenly</a></label><ul><li><a href=/en/gradually-then-suddenly/intro/>Intro</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-cant-be-copied/>Bitcoin Can’t Be Copied</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-not-too-volatile/>Bitcoin Is Not Too Volatile</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-does-not-waste-energy/>Bitcoin Does Not Waste Energy</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-not-too-slow/>Bitcoin is Not Too Slow</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-fixes-this/>Bitcoin Fixes This</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-not-blockchain/>Bitcoin, Not Blockchain</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-not-backed-by-nothing/>Bitcoin is Not Backed by Nothing</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-not-a-pyramid-scheme/>Bitcoin is Not a Pyramid Scheme</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-cannot-be-banned/>Bitcoin Cannot be Banned</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-not-for-criminals/>Bitcoin is Not for Criminals</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-obsoletes-all-other-money/>Bitcoin Obsoletes All Other Money</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-a-rally-cry/>Bitcoin is a Rally Cry</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-common-sense/>Bitcoin is Common Sense</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-antifragile/>Bitcoin is Antifragile</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-one-for-all/>Bitcoin is One for All</a></li><li><a href=/en/gradually-then-suddenly/bitcoin-is-the-great-definancialization/>Bitcoin is the Great Definancialization</a></li></ul></li><li><input type=checkbox id=section-dcadc98a07b7e2ce216dc99178d52c35 class=toggle>
<label for=section-dcadc98a07b7e2ce216dc99178d52c35 class="flex justify-between"><a href=/en/discovering-bitcoin/>Discovering Bitcoin</a></label><ul><li><a href=/en/discovering-bitcoin/intro/>Introduction</a></li><li><a href=/en/discovering-bitcoin/about-time/>About Time</a></li><li><a href=/en/discovering-bitcoin/about-people/>About People</a></li><li><a href=/en/discovering-bitcoin/introducing-money/>Introducing Money</a></li><li><a href=/en/discovering-bitcoin/a-wrong-turn-new-plan-needed/>A Wrong Turn (New Plan Needed)!</a></li><li><a href=/en/discovering-bitcoin/digital-scarcity/>Digital Scarcity</a></li><li><a href=/en/discovering-bitcoin/digital-contracts/>Digital Contracts</a></li><li><a href=/en/discovering-bitcoin/the-missing-pieces/>The Missing Pieces</a></li></ul></li><li><a href=/en/bitcoin-is-not-harmful-for-the-environment/>Bitcoin Is Not Harmful For The Environment</a></li><li><a href=/en/seven-network-effects-of-bitcoin/>The Seven Network Effects of Bitcoin</a></li><li><a href=/en/masters-and-slaves-of-money/>Masters and Slaves of Money</a></li><li><a href=/en/structural-adjustment/>Structural Adjustment</a></li><li><a href=/en/in-defense-of-deflation/>In Defense Of Deflation</a></li><li><a href=/en/comparison-of-monetary-standards/>Comparison of Monetary Standards</a></li><li><a href=/en/petrodollar-negative-effects/>Petrodollar Negative Effects</a></li><li><a href=/en/shelling-out/>Shelling Out: The Origins of Money</a></li><li><a href=/en/bitcoin-rhythms-of-history/>Bitcoin and the Rhythms of History</a></li><li><a href=/en/bitcoin-and-the-hopf-cycle-of-the-internet/>Bitcoin & the HOPF Cycle of the Internet</a></li><li><a href=/en/money-blockchains-and-social-scalability/>Money, blockchains, and social scalability</a></li><li><a href=/en/what-is-money/>What Is Money</a></li><li><a href=/en/only-the-strong-survive/>Only The Strong Survive</a></li><li><a href=/en/dollar-cost-averaging/>Dollar-Cost Averaging</a></li><li><a href=/en/jevons-paradox/>Jevons Paradox: Contrary Truth</a></li></ul></li><li><input type=checkbox id=section-7607f4888796b50750900ae1fa41174c class=toggle>
<label for=section-7607f4888796b50750900ae1fa41174c class="flex justify-between"><a href=/en/security/>Security</a></label><ul><li><a href=/en/how-to-hold-private-keys/>Bitcoin Wallets: How, Why and When to Hold Your Own Private Keys</a></li><li><a href=/en/seed/>What is a bitcoin seed phrase and how does it work?</a></li><li><a href=/en/seed-security/>Ultimate guide to storing your bitcoin seed phrase backups</a></li><li><a href=/en/passphrase/>Is your passphrase strong enough?</a></li><li><a href=/en/what-is-multisig/>What is multisig?</a></li><li><a href=/en/hwws/>The best Bitcoin hardware wallets</a></li><li><a href=/en/multisig-1/>Multisig Part I: Why Multisig?</a></li><li><a href=/en/multisig-2/>Multisig Part II: Single Keys are the Foundation of Multisignature</a></li></ul></li><li><input type=checkbox id=section-6e81d9ae00d8c0e44f4b6c22008f433f class=toggle>
<label for=section-6e81d9ae00d8c0e44f4b6c22008f433f class="flex justify-between"><a href=/en/privacy/>Privacy</a></label><ul><li><a href=/en/privacy/best-practices/>Bitcoin Privacy: Best Practices</a></li><li><a href=/en/privacy/no-kyc/>no-KYC only. Avoid the creep</a></li><li><a href=/en/wiki-bitcoin-privacy/>Bitcoin Privacy</a></li><li><a href=/en/bitcoin-becomes-critical/>Bitcoin Becomes Critical</a></li><li><a href=/en/bip47-the-ugly-duckling/>BIP47, the ugly duckling</a></li><li><input type=checkbox id=section-fa948e4e97baac946689641ce96c1e94 class=toggle>
<label for=section-fa948e4e97baac946689641ce96c1e94 class="flex justify-between"><a href=/en/privacy/oxt/>Understanding Bitcoin Privacy with OXT</a></label><ul><li><a href=/en/privacy/oxt-1/>Part 1: Chain Analysis And Transaction Privacy</a></li><li><a href=/en/privacy/oxt-2/>Part 2: Chain Analysis Core Concepts</a></li><li><a href=/en/privacy/oxt-3/>Part 3: Defences Against Chain Analysis</a></li><li><a href=/en/privacy/oxt-4/>Part 4: Applying Chain Analysis Concepts To Improve User Privacy</a></li></ul></li><li><a href=/en/privacy/coinjoin/>CoinJoin Overview</a></li><li><a href=/en/bitcoin-fungibility/>Bitcoin Fungibility</a></li><li><a href=/en/freesamourai/>#FreeSamourai</a></li></ul></li><li><input type=checkbox id=section-7703f58e8cfca24f7e8f10e99f7fd772 class=toggle>
<label for=section-7703f58e8cfca24f7e8f10e99f7fd772 class="flex justify-between"><a href=/en/protocol/>Protocol</a></label><ul><li><a href=/en/who-controls-bitcoin-core/>Who Controls Bitcoin Core?</a></li><li><a href=/en/bitcoins-eternal-struggle/>Bitcoin's Eternal Struggle</a></li><li><a href=/en/on-bitcoins-ux/>On Bitcoin’s UX</a></li><li><a href=/en/bitcoin-digital-gold-or-ecash/>Bitcoin: Digital Gold or Peer-to-Peer Cash?</a></li><li><a href=/en/bitcoin-governance/>Bitcoin Governance</a></li><li><a href=/en/trusted-third-parties/>Trusted Third Parties are Security Holes</a></li><li><a href=/en/21-million-is-non-negotiable/>21 Million is Non-Negotiable</a></li><li><a href=/en/proof-of-work/>Proof of Work, a pictorial essay</a></li><li><a href=/en/proof-of-stake-is-a-scam/>Proof of stake is a scam</a></li><li><a href=/en/was-satoshi-a-greedy-miner/>Was Satoshi a Greedy Miner?</a></li><li><a href=/en/segwit/>What Is SegWit</a></li><li><a href=/en/taproot/>What Is Taproot</a></li><li><a href=/en/coercion-of-ethereums-difficulty-bomb/>The Coercion Of Ethereum's Difficulty Bomb</a></li><li><a href=/en/rgb/>Understanding the RGB protocol</a></li><li><a href=/en/difficulty/>Bitcoin Difficulty Adjustment</a></li><li><a href=/en/bitcoin-address-types/>Bitcoin address types</a></li><li><a href=/en/myths-about-halving/>Myths About the Bitcoin Halving</a></li><li><a href=/en/mining-walkthrough/>SHA256 and Bitcoin Mining Walkthrough</a></li><li><input type=checkbox id=section-f1564ca04cb3a2764bdfe28910075cd7 class=toggle>
<label for=section-f1564ca04cb3a2764bdfe28910075cd7 class="flex justify-between"><a href=/en/protocol/utxo/>What Is UTXO And How To Manage Them</a></label><ul><li><a href=/en/protocol/utxo-1/>What is a Bitcoin UTXO</a></li><li><a href=/en/protocol/utxo-2/>Too Many UTXOs: How To Avoid High Fees</a></li><li><a href=/en/protocol/utxo-3/>UTXOs Privacy</a></li></ul></li><li><a href=/en/transaction-size/>Transaction Size</a></li><li><a href=/en/on-ossification/>On Ossification</a></li></ul></li><li><input type=checkbox id=section-3b225c8aaa13f68b831829121e8a96ea class=toggle>
<label for=section-3b225c8aaa13f68b831829121e8a96ea class="flex justify-between"><a href=/en/history/>History</a></label><ul><li><input type=checkbox id=section-6a04f6b3dd7c2dea74ad7a9a3b27156f class=toggle>
<label for=section-6a04f6b3dd7c2dea74ad7a9a3b27156f class="flex justify-between"><a href=/en/gf/>The Genesis Files</a></label><ul><li><a href=/en/gf/genesis-intro/>Intro</a></li><li><a href=/en/gf/genesis-1/>Part I: How David Chaum’s eCash Spawned a Cypherpunk Dream</a></li><li><a href=/en/gf/genesis-2/>Part II: Hashcash or How Adam Back Designed Bitcoin’s Motor Block</a></li><li><a href=/en/gf/genesis-3/>Part III: If Bitcoin Had a First Draft, Wei Dai’s B-Money Was It</a></li><li><a href=/en/gf/genesis-4/>Part IV: With Bit Gold, Szabo Was Inches Away From Inventing Bitcoin</a></li><li><a href=/en/gf/genesis-5/>Part V: How Hal Finney’s Quest For Digital Cash Led To RPOW (And More)</a></li></ul></li><li><a href=/en/hal-finney/>Hal Finney — The Life And Death Of A Cypherpunk Legend</a></li><li><a href=/en/bitcoin-and-me/>Bitcoin and Me</a></li><li><a href=/en/bitcoin-reformation/>The Bitcoin Reformation</a></li><li><a href=/en/bitcoin-forks/>A complete history of Bitcoin’s consensus forks</a></li><li><a href=/en/analyzing-2013-fork/>Analyzing the 2013 Bitcoin fork</a></li></ul></li><li><input type=checkbox id=section-8deaa51eea3af90eb190b70b9511c351 class=toggle>
<label for=section-8deaa51eea3af90eb190b70b9511c351 class="flex justify-between"><a href=/en/philosophy/>Philosophy</a></label><ul><li><input type=checkbox id=section-c0de4237ba1d1d542c91bf085525457d class=toggle>
<label for=section-c0de4237ba1d1d542c91bf085525457d class="flex justify-between"><a href=/en/what-i-learned-from-bitcoin/>What I've Learned From Bitcoin</a></label><ul><li><a href=/en/what-i-learned-from-bitcoin-1/>Part I. Philosophical Teachings of Bitcoin</a></li><li><a href=/en/what-i-learned-from-bitcoin-2/>Part II. Economic Teachings of Bitcoin</a></li><li><a href=/en/what-i-learned-from-bitcoin-3/>Part III. Technological Teachings of Bitcoin</a></li></ul></li><li><a href=/en/not-shitcoin/>Why Bitcoin, Not Shitcoin</a></li><li><a href=/en/inalienable-property-rights/>Inalienable Property Rights</a></li><li><a href=/en/crypto-anarchist-manifesto/>The Crypto Anarchist Manifesto</a></li><li><a href=/en/cypherpunks-manifesto/>A Cypherpunk's Manifesto</a></li><li><a href=/en/dutch-tulip-bubble/>Is Bitcoin Like the Dutch Tulip Bubble?</a></li><li><a href=/en/everyones-a-scammer/>Everyone's a Scammer</a></li><li><a href=/en/freedom-of-value/>The Freedom of Value</a></li><li><a href=/en/bitcoin-meme/>Bitcoin Is The Only Real Meme</a></li><li><a href=/en/number-zero-and-bitcoin/>The Number Zero and Bitcoin</a></li><li><a href=/en/crypto-bro/>Dear Crypto & Fiat Bros</a></li><li><a href=/en/fighting-fake-bitcoin/>Fighting Fake Bitcoin</a></li><li><a href=/en/bitcoin-is-the-mycelium/>Bitcoin is The Mycelium of Money</a></li><li><a href=/en/proof-of-life/>Proof of Life. Why Bitcoin is a Living Organism</a></li><li><a href=/en/most-peaceful-revolution/>A Most Peaceful Revolution</a></li><li><a href=/en/bitcoin-universe/>Bitcoin Universe</a></li><li><a href=/en/bitcoin-dissidents/>Bitcoin Dissidents</a></li><li><a href=/en/bitcoin-equals-freedom/>Bitcoin Equals Freedom</a></li></ul></li><li><input type=checkbox id=section-acee29309cd01b51e216d2d768d75871 class=toggle>
<label for=section-acee29309cd01b51e216d2d768d75871 class="flex justify-between"><a href=/en/future/>Future</a></label><ul><li><input type=checkbox id=section-8b8bdf99eb0d858d5adbfb2d713a72dc class=toggle>
<label for=section-8b8bdf99eb0d858d5adbfb2d713a72dc class="flex justify-between"><a href=/en/ba/>Bitcoin Astronomy</a></label><ul><li><a href=/en/ba/1/>Part I</a></li><li><a href=/en/ba/2/>Part II</a></li><li><a href=/en/ba/3/>Part III</a></li></ul></li><li><a href=/en/hey-bitcoin-slow-down/>Hey Bitcoin, Slow Down!</a></li><li><a href=/en/apocalypse/>Can Bitcoin Survive An Apocalypse?</a></li><li><a href=/en/bitcoin-and-oceans/>Bitcoin and Ocean Thermal Energy</a></li></ul></li><li><input type=checkbox id=section-7273d708b600eaa6617c228cdd2d9524 class=toggle checked>
<label for=section-7273d708b600eaa6617c228cdd2d9524 class="flex justify-between"><a href=/en/lightning/>Lightning</a></label><ul><li><a href=/en/what-is-lightning-network/>What is Lightning Network?</a></li><li><a href=/en/lightning-wallets/>Lightning Wallets</a></li><li><a href=/en/how-lightning-address-works/>How Lightning Address Works</a></li><li><a href=/en/lightning-network-privacy/>Lightning Network Privacy</a></li><li><a href=/en/is-lightning-centralized/>Is Lightning centralized?</a></li><li><a href=/en/lightning-network-explained/ class=active>Lightning Network Explained</a></li><li><a href=/en/inbound-liquidity-problem/>Solutions to inbound liquidity problem</a></li></ul></li></ul></li><li><input type=checkbox id=section-ebedd809137a39943c3339b07b86856f class=toggle>
<label for=section-ebedd809137a39943c3339b07b86856f class="flex justify-between"><a href=/en/practice/>Practice</a></label><ul><li><input type=checkbox id=section-a04618d8af5c321dea142dada821f01f class=toggle>
<label for=section-a04618d8af5c321dea142dada821f01f class="flex justify-between"><a href=/en/practice/buy/>Buy</a></label><ul><li><a href=/en/newbie-buy/>Buy and Hodl Bitcoin for Beginners</a></li><li><a href=/en/hodl-hodl/>Buy noKYC Bitcoin with HodlHodl</a></li><li><a href=/en/robosats/>RoboSats: Private P2P Exchange</a></li></ul></li><li><input type=checkbox id=section-52e946c82575a11d29d8ca1021a1b878 class=toggle>
<label for=section-52e946c82575a11d29d8ca1021a1b878 class="flex justify-between"><a href=/en/practice/hodl/>Hodl</a></label><ul><li><a href=/en/electrum/>Electrum Bitcoin Wallet</a></li><li><a href=/en/blue/>Installing Blue Wallet</a></li><li><a href=/en/seedsigner/>SeedSigner: DIY Bitcoin Signing Device</a></li><li><a href=/en/coldcard/>What is Coldcard?</a></li></ul></li><li><input type=checkbox id=section-7778724fd028202526d77fda64e80716 class=toggle>
<label for=section-7778724fd028202526d77fda64e80716 class="flex justify-between"><a href=/en/practice/interact/>Interact</a></label><ul><li><a href=/en/practice/bitcoin-node/>Why You Should Run Your Own Bitcoin Node</a></li><li><a href=/en/orangepilling-in-5-min/>Orangepilling in 5 min</a></li><li><a href=/en/5-tips-for-teaching-bitcoin/>5 tips for teaching Bitcoin</a></li></ul></li><li><input type=checkbox id=section-42375023512d85163c1ed33595577cc3 class=toggle>
<label for=section-42375023512d85163c1ed33595577cc3 class="flex justify-between"><a href=/en/practice-privacy/>Privacy</a></label><ul><li><input type=checkbox id=section-489729314822a64eb481d2971b819168 class=toggle>
<label for=section-489729314822a64eb481d2971b819168 class="flex justify-between"><a href=/en/practice-privacy/dojo/>Dojo x86 Bitcoin Node Guide</a></label><ul><li><a href=/en/practice-privacy/dojo-0/>Introduction</a></li><li><a href=/en/practice-privacy/dojo-1/>Installing Bitcoin Core & Tor</a></li><li><a href=/en/practice-privacy/dojo-2/>Installing Fulcrum Indexer</a></li><li><a href=/en/practice-privacy/dojo-3/>Installing Mempool Explorer</a></li><li><a href=/en/practice-privacy/dojo-4/>Installing Samourai Dojo</a></li><li><a href=/en/practice-privacy/dojo-5/>Firewall Configuration</a></li><li><a href=/en/practice-privacy/dojo-6/>Installing Package Updates</a></li></ul></li><li><a href=/en/practice-privacy/ronindojo/>RoninDojo x86 Installation Guide</a></li><li><a href=/en/grapheneos/>GrapheneOS: De-Google your phone</a></li></ul></li><li><input type=checkbox id=section-1ee5fbef80ad0a274c597a531c90648c class=toggle>
<label for=section-1ee5fbef80ad0a274c597a531c90648c class="flex justify-between"><a href=/en/practice/lightning/>Lightning</a></label><ul><li><a href=/en/phoenix/>Phoenix: The Non-Custodial Lightning Wallet</a></li><li><a href=/en/lnbits/>LNbits: A Swiss knife among Lightning apps</a></li><li><a href=/en/alby-and-nostr/>Alby and Nostr</a></li><li><a href=/en/zapplanner/>Recurring Lightning Payments</a></li><li><a href=/en/lntips/>Telegram bot @LightningTipBot</a></li><li><a href=/en/lightning-liquidity-management-guide/>Lightning Liquidity Management Guide</a></li><li><a href=/en/mutiny/>Starting with Mutiny Wallet</a></li></ul></li></ul></li><li><input type=checkbox id=section-0fbeb231f88c8b74f36060fd3f3377c6 class=toggle>
<label for=section-0fbeb231f88c8b74f36060fd3f3377c6 class="flex justify-between"><a href=/en/rabbithole/>Rabbithole</a></label><ul></ul></li></ul><div class=menuSep></div><ul><li><input type=checkbox id=section-5c8dd08fbf75826bbf8b24f27b15430e class=toggle>
<label for=section-5c8dd08fbf75826bbf8b24f27b15430e class="flex justify-between"><a href=/en/contribute/>Contribute</a></label><ul><li><a href=/en/github/>Adding an Article</a></li></ul></li><li><span>Blog</span></li><li><a href=/en/feedback/>Feedback</a></li></ul><div class=menuBlock><div id=metrics-container class=metrics-container><div id=metrics-label></div><div id=metrics-value></div></div></div></nav><footer><br><a class=menuSocialButton href=https://t.me/bitcoin21ideas target=_blank title=Telegram><svg viewBox="0 0 25 25"><path d="m12 0C5.373.0.0 5.373.0 12s5.373 12 12 12 12-5.373 12-12c0-6.627-5.373-12-12-12zm5.894 8.221-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002.0-.003.0-.005.0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121L8.32 13.617l-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/></svg>
</a>&nbsp;
<a class=menuSocialButton href=https://github.com/21ideas-org/21ideas.org target=_blank title=GitHub><svg viewBox="0 0 820 820"><path d="M4e2 9.9C179.11 9.9.0 189 0 409.94.0 585.6 113.24 734.86 270.71 788.61l2.83.83c20 3.76 27.34-8.59 27.34-19.24.0-9.49-.32-34.68-.5-68-111.27 24.14-134.75-53.68-134.75-53.68a106.58 106.58.0 00-44.09-58.26l-.43-.24c-36.23-24.81 2.8-24.3 2.8-24.3A84.06 84.06.0 01185 606.54l.22.4a85.24 85.24.0 00116.92 33l-.43.21A85.16 85.16.0 01327 586.7C238.19 576.67 144.8 542.25 144.8 389c0-.72.0-1.55.0-2.38a153.82 153.82.0 0141.27-105l-.08.11a139.82 139.82.0 01-8.56-48.58 141.91 141.91.0 0112.4-58.21l-.37.91s33.51-10.72 110 41c30-8.56 64.43-13.5 1e2-13.5a378.09 378.09.0 01102.68 14.14l-2.67-.64c76-51.72 109.51-41 109.51-41a144 144 0 0112 58.07 145.56 145.56.0 01-8.35 48.82l.32-1a154.37 154.37.0 0141 105c0 .83.0 1.63.0 2.43V389c0 153.68-93.5 187.51-182.52 197.35a95.48 95.48.0 0127.27 66.93c0 2.48-.11 5-.3 7.42v-.32c0 53.54-.51 96.54-.51 109.53.0 10.51 7 23 27.51 19C686.25 734.78 8e2 585.39 8e2 409.41 8e2 188.74 621.11 9.87 400.47 9.87H4e2z"/></svg>
</a>&nbsp;
<a class=menuSocialButton href=https://njump.me/npub1lm3f47nzyf0rjp6fsl4qlnkmzed4uj4h2gnf2vhe3l3mrj85vqks6z3c7l target=_blank title=Nostr><svg viewBox="0 0 820 820"><path d="M4e2 797.5c219.53.0 397.5-178 397.5-397.5S619.53 2.5 4e2 2.5 2.5 180.47 2.5 4e2 180.47 797.5 4e2 797.5zM598.23 242.15c6.82 8.46 10.35 18.14 11.45 28.86 1.7 16.37-2.68 31.17-11.2 45-14.19 23.62-43.17 39.63-45.85 41-5.42 2.86-7.42 7.12-7.06 13.34s-1.21 37.19-20 50.83c-9.68 7-48.64 16-66.6 19.05a28.61 28.61.0 00-13.18 5.37c-1 .67-2 1.36-3.2 2.06-6.82 4.27-31.23 38-35.31 45.48l10.66-3.27c21.2-6.53 66.85-20.6 69.52-21 9-1.4 15.89 1.22 20.34 7.79 3.63 5.41 7.18 10.81 10.75 16.25.61.94 1.23 1.87 1.85 2.81 1 1.54 2 3.08 2.93 4.62.48.78 1 1.55 1.45 2.32l1.52 2.38c.09.14.19.29.28.45a10.65 10.65.0 011.37 2.83c.24 1 .91 4.14-.92 6.09-1.7 1.77-4.63 1.77-6.21 1.34a15.65 15.65.0 01-5.6-2.8l-2.49-2.13c-2-1.71-5.73-2.56-8.71-2.44-3.41.13-8-1-10.11-2.37-4.2-2.74-5.35-9.56-5.35-9.68a3.51 3.51.0 00-3.72-2.86 18.58 18.58.0 00-6.28 1.15l-.78.25q-15 4.56-29.93 9.24h0l-14.31 4.45c-7.06 2.19-14.12 4.38-21.13 6.69a37.45 37.45.0 00-5.72 2.62c-.43.21-.84.43-1.25.64l-1.24.64h0c-.85.42-1.7.85-2.55 1.34l-.27.15a30.59 30.59.0 01-5.76 2.65c-7.12 2.13-13.39-1-16.32-8.1-1.88-4.63-.18-13.76.86-16.44 5.58-14.35 21.77-39.58 26.28-46.6.75-1.17 1.17-1.83 1.17-1.86-.36-.12-23.25 9.07-27 11.93-10.35 7.86-34.64 26.49-35 28.31A22.75 22.75.0 01331 508.13c-5.66 2.19-9.13 6.7-12.48 11.08.0.0-60.88 83.83-65 88.34l-.68.74c-2.83 3-12.28 13.16-15 18.13-.46.83-1.61 3.27-2.58 5.33-.6 1.26-1.13 2.38-1.38 2.89.0.05-.05.11-.08.17-.59 1.21-1.91 3.9-6.31 3.66s-4.79-6.12-5-9.09v-.4c-.54-6.88 1-13.7 4.63-20.82a6.46 6.46.0 01.31-.58c1-1.8 3.93-7 2.61-11.36s-2.61-11.14-.6-14.61c2.84-4.77 7.62-5.48 13.92-6.41l2.64-.41c5.29-.85 9.13-3.53 12.84-8.88 4.66-6.84 17-24.51 27.65-39.67C293.62 516 3e2 507 302.66 503.09a25.55 25.55.0 003.77-9.08c1.89-9.74 7.85-16.49 18.14-20.7 2.25-.85 43.17-35.06 43.17-39.45.0-3.1-4.45-4.87-7.92-5.78-.48-.12-26.24-6.82-37.92-12.12A88.58 88.58.0 01305 406.41c-7.53-5.54-22.23-3.16-25.3-2.67l-.27.05c-11 1.58-19.12 6.51-28.37 12.78-1.65 1.16-10.05 4.2-14.31 1.77-1.32-.75-2.9-1.6-4.65-2.54-9.16-4.92-22.91-12.31-28.59-20.9-3.11-4.69-2.68-12.42-.49-20.94 7.07-19.73 17.48-28.56 36.77-33.91 11.39-3.95 32.41-5.33 46.84-6.28 2.93-.19 5.59-.37 7.84-.54.12-.05.8-.09 1.94-.18 7-.51 31.32-2.27 49.13-11.39 1.61-.82 3.59-1.92 5.91-3.2 17.67-9.8 55.68-30.86 107.76-29.25 12.95.4 32.15 7.45 49.77 13.93 14.79 5.43 28.46 10.45 36.38 10.79 17.65.73 26.54-1.22 36.77-11.81 2.92-3.05 15.16-29.53 3.59-44a108.64 108.64.0 00-13.94-14.55q-2.28-1.94-4.59-3.85a183.79 183.79.0 01-15.8-14.29c-13.82-14.61-18.09-34.58-11.51-50.17 4.14-10.9 13-15.65 25.63-13.15 6.22 1.24 11.28 5.49 15.95 9.41a73.24 73.24.0 005.84 4.59c3.6 2.38 9.56 3.78 13.46 4.69 4.93 1.16 8.65 4.93 8.4 7.49s-6.7 4.75-13 4.26c-7.36-.49-20.09-.55-27.7 2-5.05 1.83-7.3 7.49-5.84 13 1.22 4.57 10.9 12.66 14.55 15.65 1.64 1.35 3.3 2.67 5 4C587.86 231.81 593.56 236.34 598.23 242.15z" fill-rule="evenodd"/></svg>
</a>&nbsp;
<a class=menuSocialButton href=/rss title=RSS><svg viewBox="-143 145 525 525"><path d="M113 145c-141.4.0-256 114.6-256 256s114.6 256 256 256 256-114.6 256-256S254.4 145 113 145zM43.1 518.7c-6.2 6.2-14.7 9.9-24.1 9.9-9.4.0-17.8-3.8-24-9.9-6.2-6.2-10-14.6-10-23.9.0-9.4 3.8-17.8 10-24s14.6-10 24-10 17.9 3.8 24 10c6.2 6.2 10 14.6 10 24C53 504.2 49.2 512.6 43.1 518.7zM104.8 529c-.1-32.1-12.5-62.3-35.1-84.9-22.6-22.6-52.8-35.2-84.7-35.2V360c46.6.0 88.7 19 119.3 49.6s49.5 72.8 49.6 119.4H104.8zm87.2.0c-.1-114.2-92.8-207.1-206.9-207.1V273c70.6.0 134.5 28.7 180.8 75.1 46.3 46.4 75 110.3 75.1 180.9H192z"/></svg>
</a>&nbsp;
<a class=menuSocialButton href=https://www.youtube.com/@21ideas target=_blank title=YouTube><svg viewBox="0 0 25 25"><path d="M12 0C5.373.0.0 5.373.0 12s5.373 12 12 12 12-5.373 12-12S18.627.0 12 0zm4.441 16.892c-2.102.144-6.784.144-8.883.0C5.282 16.736 5.017 15.622 5 12c.017-3.629.285-4.736 2.558-4.892 2.099-.144 6.782-.144 8.883.0C18.718 7.264 18.982 8.378 19 12c-.018 3.629-.285 4.736-2.559 4.892zM10 9.658l4.917 2.338L10 14.342V9.658z"/></svg></a></footer><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page book-page-page"><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Lightning Network Explained</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#0-why>0. Why?</a></li><li><a href=#1-idea>1. Idea</a><ul><li><a href=#11-payment-channel>1.1. Payment channel</a></li><li><a href=#12-network-of-payment-channels>1.2. Network of payment channels</a></li><li><a href=#13-the-problem-of-trust>1.3. The problem of trust</a></li></ul></li><li><a href=#2-smart-contracts>2. Smart contracts</a><ul><li><a href=#21-authorisation>2.1. Authorisation</a></li><li><a href=#22-cooperation>2.2. Cooperation</a></li><li><a href=#23-timing>2.3. Timing</a></li></ul></li><li><a href=#3-payment-channel-implementation>3. Payment channel implementation</a><ul><li><a href=#31-opening-the-channel>3.1. Opening the channel</a></li><li><a href=#32-using-the-channel>3.2. Using the channel</a></li></ul></li><li><a href=#4-lightning-network>4. Lightning Network</a><ul><li><a href=#41-payment-channel-though-an-intermediary>4.1. Payment channel though an intermediary</a></li><li><a href=#42-routing>4.2. Routing</a></li><li><a href=#43-fees-economy>4.3. Fees economy</a></li><li><a href=#44-criticism>4.4. Criticism</a></li></ul></li><li><a href=#5-ln-today>5. LN today</a></li></ul></nav></aside></header><div class=pageCover><picture><img src=/img/mln-850.jpeg alt=Cover></picture></div><h1>Lightning Network Explained</h1><div class=pageDate>January 30, 2018</div><article class=markdown><blockquote class="book-hint btc"><p>This article by Dmitry Laptev was published in his <a href=https://medium.com/lightningto-me/lightning-network-45b4b2119d97>Medium blog</a>.</p><p><a href=/contribute/>Contribute</a>.</p></blockquote><p>First, we discuss why we need it (part 0) and describe an idea of payment channels and Lightning Network (part 1). Then we introduce required building blocks (part 2) and see how these blocks can be used to create payment channels (part 3). We then finally build Lightning Network, discuss its properties (part 4), and sum it all up (part 5).</p><blockquote><p><em>Disclaimer. I consciously omit/simplify some of the technical details. And also I am not an expert, and can be simply wrong.</em></p></blockquote><h1 id=0-why>0. Why?
<a class=anchor href=#0-why>#</a></h1><p>Bitcoin blockchain is a kind of decentralized database that stores every bitcoin transaction ever made. Here “every transaction ever” is a fundamental part of the protocol design. For system to be truly distributed and to prevent any mistakes, thousands of network nodes need to constantly double check each other and to record all the transactions.</p><p>Of course, this does not help scalability <em>at all</em>. Blockchain requires tens of gigabytes of hard drive storage, blocks are full, fees are rising, people are angry and fork bitcoin. Because of all that, alternative solutions are currently being developed. And one of these solutions is <em>Lightning Network (LN)</em>.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Q: When will the Lightning Network be rolled out?<br>A: The rollout has already begun. This is an iterative distributed learning process; it's unlikely there will be a single point in time at which we say LN is "deployed" because it will grow organically. Software is never finished.</p>&mdash; Jameson Lopp (@lopp) <a href="https://twitter.com/lopp/status/947808940255006726?ref_src=twsrc%5Etfw">January 1, 2018</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h1 id=1-idea>1. Idea
<a class=anchor href=#1-idea>#</a></h1><p>The idea of the <em>Lightning Network</em>, which belongs to a broader set of <em>second layer solutions</em>, is actually quite simple.</p><blockquote class="book-hint btc"><em>💡 Instead of storing and verifying all the transactions in the blockchain, let’s conduct most of the transactions “off-chain”. The main blockchain will mostly be used to synchronise the balances from time to time and to resolve conflicts. And as usual, this will all work using cryptomagic.</em></blockquote><p>This sounds intriguing, but absolutely unclear <em>how</em>…</p><h2 id=11-payment-channel>1.1. Payment channel
<a class=anchor href=#11-payment-channel>#</a></h2><p>Let’s start with simplifying the lives of two people (Alice and Bob), who often transact between each other. The following scheme is proposed.</p><ol><li>Alice and Bob send deposits to a special address. This address is jointly controlled by both of them using their two private keys.</li><li>Both Alice and Bob create a special <em>smart contract transaction</em> (yes, there are smart contracts in bitcoin, but more about that in the next part). This transaction is valid, but not yet recorded in the blockchain.</li><li>At first, the transaction contains information that Alice and Bob can get their deposits back.</li><li>When Alice is paying to Bob, they both by mutual agreement update the information in these transactions. Alice agrees to get less than her initial deposit, Bob — more. One can say for the sake of analogy that they are exchanging debt acknowledging documents (<em>IOU, I owe you</em>). But unlike most IOUs issued by banks, LN payments are fully secured and guaranteed to be immediately redeemable.</li><li>Like this, they can exchange small amounts (within the limits of their deposits) with each other, for as long as they both want.</li><li>At any moment in time any party can decide to square their balances. Then Alice (or Bob) just records the final version of their transaction to the main blockchain and they both get their deposits back (taking into account all the intermediate payments).</li></ol><p>Points 1–3 in these plan are called <em>opening the payment channel</em>. Points 4 and 5 — <em>using the channels.</em> Point 6 — <em>closing the payment channel</em>.</p><blockquote class="book-hint btc"><em>👍 Only two transactions are recorded in the main blockchain: sending the initial deposits (to open the channel), and the final transaction (to close the channel). All the intermediate payments are conducted without blockchain synchronisation. This makes payments within channels free and instant.</em></blockquote><h2 id=12-network-of-payment-channels>1.2. Network of payment channels
<a class=anchor href=#12-network-of-payment-channels>#</a></h2><p>Payment channels between two people <em>per se</em> are not super useful. Ultimately, we do not transact regularly with most people. But…</p><blockquote class="book-hint btc"><em>💡 When multiple payment channels form a network, any two people in this network can transact between each other. If there is a path between two nodes in the network, they can pay each other, even if they are not directly connected. This is the main idea of Lightning Network.</em></blockquote><div class=imageWrapper><img src=/img/mln-851.png><p><em>Mainnet LN: the graph of payment channels as of 22.01.2018 (<a href=https://lnmainnet.gaben.win>https://lnmainnet.gaben.win</a>).</em></p></div><p>Basically, analogous to TCP protocol, most people will need to have only one open channel to transact with anyone else.</p><p>Of course, there are many open questions left: how to find a path between two people, and how to motivate nodes to process payments. But let’s start with the main issue: the problem of trust.</p><h2 id=13-the-problem-of-trust>1.3. The problem of trust
<a class=anchor href=#13-the-problem-of-trust>#</a></h2><p>As it often happens in cryptography, the system of payment channels is easy to imagine when all the parties trust each other. There is no need in deposits, keys, special transactions. We can all just write down who owns whom and how much.</p><p>The question is: how to implement a payment channel and a network of payments channels <em>without trust</em>. There are going to be three main issues.</p><ol><li>Both Alice and Bob store their deposit in a joined wallet. If Bob refuses to sign transactions, then how will Alice ever return her deposit?</li><li>When transacting over the payment channel, Alice and Bob create many versions of IOU transactions. Assume Alice is mostly paying Bob. Then in the last version of the transaction Bob should receive more than his deposit. But Alice can cheat and submit the very first valid transaction, pretending that she never owed Bob anything. What shall Bob do in this case?</li><li>Assume Alice is paying Bob through Victor in the network of payment channels. How can they be sure that Victor will indeed pass the money, and not just steal it?</li></ol><p>We will call these issues, respectively: <em>“the problem of a joined deposit”</em>, <em>“the problem of the last transaction”</em> and <em>“the problem of intermediary”</em>.</p><p>All of the mentioned issues can actually be resolved using only a couple of tricks. But let’s not get ahead of ourselves. First, we will introduce some required building blocks…</p><h1 id=2-smart-contracts>2. Smart contracts
<a class=anchor href=#2-smart-contracts>#</a></h1><p>Bitcoin supports a simple smart contract programming language, called <a href=https://en.bitcoin.it/wiki/Script><em>Script</em></a>. Every bitcoin transaction has a special field that contains a small script in this language. This script checks under which conditions the output of the transaction can be spend.</p><p><em>“To spend the output of transaction A”</em> is in fact just a more technically correct way of saying “to spend bitcoins from address/wallet <em>K</em>, to which these bitcoins were delivered using transaction <em>A</em>”.</p><blockquote class="book-hint btc"><em>☝ In comparison with ethereum, capabilities of smart contract in bitcoin are much more limited. This is because of the fact that Script is not a Turing-complete language. E.g. Script does not allow cycles/recursion, and does not allow creating variables (there is no memory).</em></blockquote><p>See the the link below to read a bit more about transactions structure and using scripts.</p><div class=imageWrapper><img src=/img/mln-855.png><p><em><a href=https://medium.com/lightningto-me/bitcoin-transactions-malleability-segwit-and-scaling-258af8ed9cbf>Bitcoin: transactions, malleability, SegWit and scaling</a></em></p></div><p>Let’s have a look at a couple of important operations of bitcoin scripts.</p><h2 id=21-authorisation>2.1. Authorisation
<a class=anchor href=#21-authorisation>#</a></h2><p>Perhaps the most standard part of every transaction is <em>signature verification</em>. Let transaction <em>A</em> fund some address <em>K</em> with some number of bitcoins. In order to later spend these bitcoins from <em>K</em>, one needs to prove that they have the key. This is checked using operation <code>OP_CheckSig</code>.</p><p>But we can additionally check something else. For example, we can check that a person has a secret number, the hash of which is equal to the given value. For that we need two operations: <code>OP_SHA256</code> (computes the hash of the provided parameter) and <code>OP_EqualVerify</code> (checks equality). In part 4 we will discuss why would anyone need that.</p><h2 id=22-cooperation>2.2. Cooperation
<a class=anchor href=#22-cooperation>#</a></h2><p>Another common example of simple bitcoin smart contracts is based on the operation <code>OP_CheckMultiSig</code>. This operation allows to spend funds from an address only when signed with multiple keys.</p><p>This principle is used for so-called <em>multiple signature</em> (<em>multisig</em>) wallets. It works approximately like a bank deposit box closed with two locks. One key belongs to a client, the second one — to an employee of the bank.</p><h2 id=23-timing>2.3. Timing
<a class=anchor href=#23-timing>#</a></h2><p>Since quite recently bitcoin also supports an operation called <code>OP_CheckSequenceVerify</code>, which allows to spend the funds only after some fixed number of blocks.</p><p>For example, this can be used to discipline people unable to save money. Blockchain works better than any piggy bank: if someone decides to freeze the savings for some time, the money will be securely frozen.</p><p>But beyond this scenario, <code>OP_CheckSequenceVerify</code> and other components are actively used for payment channel implementation.</p><h1 id=3-payment-channel-implementation>3. Payment channel implementation
<a class=anchor href=#3-payment-channel-implementation>#</a></h1><p>Now with all the building blocks ready, we can describe how payment channels actually work.</p><p>In reality, there exists a <a href=https://en.bitcoin.it/wiki/Payment_channels>whole variety</a> of different payment channels, and the first one was proposed by Satoshi him/her/them-self. We will <em>approximately</em> follow the specification called <em>Poon-Dryja payment channels</em> (named after the two authors of <a href=https://lightning.network/lightning-network-paper.pdf>the Lightning Network paper</a>).</p><h2 id=31-opening-the-channel>3.1. Opening the channel
<a class=anchor href=#31-opening-the-channel>#</a></h2><ol><li>Alice and Bob create a transaction/transactions transferring their money to a joined deposit address <em>O</em>. Assume that Alice transfers <em>X</em> bitcoins from her wallet, Bob transfers <em>Y</em> bitcoins. The funds from this joined deposit can only be spent when signed with two keys from Alice and Bob (<code>OP_CheckMultiSig</code>).</li><li>The first trick is that they do <em>NOT</em> yet sign the transaction and do <em>NOT</em> yet submit this transaction to the blockchain. Otherwise Bob can refuse to cooperate and Alice will lose access to her money forever.</li><li>Instead, Alice and Bob create two new refund transactions (<em>A1</em> and <em>B1</em> respectively). The input of these transactions is the money from the joint account (the output of transaction <em>O</em>). There are two outputs: <em>X</em> bitcoins is to be transferred back to Alice, and <em>Y</em> — back to Bob. <em>In reality everything is a bit more complicated, but we’ll discuss it later.</em></li><li>Then Bob signs the transaction <em>A1</em> and gives it to Alice. Alice signs the transaction <em>B1</em> and gives it to Bob.</li><li>And now the initial deposit transaction <em>O</em> can be safely recorded in the main blockchain. No one is going to freeze anyones money. If Bob refuses to cooperate, Alice will just sign her transaction <em>A1</em>, record it in the blockchain and will return her deposit.</li></ol><div class=imageWrapper><img src=/img/mln-852.png><p><em>Deposit refund transactions.</em></p></div><p>Now <em>“the problem of a joint deposit”</em> is solved. The channel can be opened without any trust to the second party.</p><blockquote class="book-hint btc"><em>☝ An interesting fact. Just half a year ago (before the SegWit activation) signing an output of an unconfirmed transaction (point 4 above) was much harder, because of <a href=https://medium.com/@x0100/c581ece107ba>transaction malleability problem</a>.</em></blockquote><h2 id=32-using-the-channel>3.2. Using the channel
<a class=anchor href=#32-using-the-channel>#</a></h2><p>Payments within a channel are in fact implemented by rewriting transactions <em>A1</em> and <em>B1</em> with the new transactions.</p><ol><li>Alice is paying Bob for a cup of coffee that costs <em>C</em>.</li><li>Alice agrees that when closing the channel, she will receive not the original amount <em>X</em>, but <em>X’=(X-C)</em>.</li><li>Bob agrees to receive <em>Y’=(Y+C)</em>.</li></ol><p>New transactions <em>A2</em> and <em>B2</em> will look exactly the same as <em>A1</em> and <em>B1</em>, but with new amounts. Any party can close the payment channel at any time, submitting the last version of the transaction to the blockchain.</p><p>How to make sure that Alice will not submit transaction <em>A1</em> instead of transaction <em>A2</em>? This is solved with the second trick.</p><ol><li>Every time Alice and Bob create new transactions, they also select a <em>one-time private key</em>. This key can be used by one party to collect the deposit of another party (<code>OP_CheckSig</code>).</li><li>With every new payment <em>i</em>, Alice is revealing to Bob her previous private key <em>AK(i-1)</em> and creates a new key <em>AKi</em>. Bob does not accept payment without the previous key.</li><li>If Bob knows Alice’s key, he can spend all the Alice’s money. But only if Alice decides to record an incorrect transaction to the blockchain.</li><li>This scheme insures that Alice is always motivated to record only the last transaction to the blockchain.</li></ol><p><em>Last small modification.</em> To dispute the transaction Alice submits to the blockchain and to provide her key, Bob needs time. Because of that Alice is not going to get her deposit immediately after she closes the channel, but after some number of blocks T (<code>OP_CheckSequenceVerify</code>). For example, she may need to wait for 48 blocks, which is approximately 8 hours.</p><div class=imageWrapper><img src=/img/mln-853.png><p><em>The final form of the transactions used for a payment channel.</em></p></div><p>If Alice signs one of her transactions (they are already signed by Bob) and submits this transaction to the blockchain, two scenarios are possible.</p><ol><li>Alice submits her last transaction => Bob does not know the last private key <em>AKi</em>. This is a valid closure of the channel, everyone should get their unspent money. Alice will get hers after some time.</li><li>Alice is trying to record her older transaction instead of the last one => she is trying to cheat. In this case Bob knows Alice’s key and he can use it to get all the Alice’s money. Obviously, Alice is not interested in this scenario.</li></ol><p>So, “<em>the problem of the last transaction</em>” is also solved. Payment channel between two people is ready. Now it also becomes clear, what are the advantages and disadvantages of using payment channels.</p><blockquote class="book-hint btc"><em><strong>👍 Advantages:</strong> 1. payments are instant and free, they do not create a burden on the main blockchain. 2. two parties do not have to trust each other.</em></blockquote><blockquote class="book-hint btc"><em><strong>👎 Disadvantages:</strong> 1. deposits are blocked for the whole time while the channel exists. 2. both parties should from time to time go online (at least once in T blocks).</em></blockquote><p>👌 In practice, both disadvantages are important for payment channels between two people, but much less important in the context of Lightning Network. First point stops being a disadvantage when one channel can be used to pay to various different people.</p><p>Second point is also basically non-existent in LN, because one can outsource correctness verification to a third party. If Bob is not online when Alice is closing the channel, and some random David discovers that Alice is cheating, then both Bob and David can split Alice’s confiscated deposit.</p><p>One more small note before we move further. You may think that operating a payment channel requires a lot of bookkeeping: tracking and signing different versions of transactions, exchanging signed these transactions and also temporary keys. And you will certainly be right. <em>Good news is: when properly implemented, this will be all happening behind the scenes</em>, the users will just send the money and receive them.</p><h1 id=4-lightning-network>4. Lightning Network
<a class=anchor href=#4-lightning-network>#</a></h1><h2 id=41-payment-channel-though-an-intermediary>4.1. Payment channel though an intermediary
<a class=anchor href=#41-payment-channel-though-an-intermediary>#</a></h2><p>Let’s now assume that Alice and Bob do not have a payment channel between each other, but both have an open channel with Victor. Alice can safely transfer money to Victor, Victor can safely transfer money to Bob.</p><p>But how to make sure that Victor, once he receives the money, will indeed pass them further to Bob?</p><p>The idea here is going to be quite similar to the previous trick. But instead of one-time private keys, they will use a secret number.</p><ol><li>When the payment is initiated, Bob selects a secret number <em>S</em>, computes a hash of this number <em>HS</em>, and transfers this information to Alice. <em>HS</em> can also be used as a virtual receipt.</li><li>Alice creates a transaction <em>AV</em> that transfers the money to Victor, but only in case Victor shows a secret number <em>S</em>. For that she uses a script checking the hash of the provided number and comparing it to the value of <em>HS</em> (this is where we need <code>OP_SHA256</code> and <code>OP_EqualVerify</code>).</li><li>Victor is creating a similar transaction <em>VB</em> transferring money to Bob, but only if Bob provides a secret number <em>S</em>.</li><li>Bob sees that he will be able to get the money from Victor and shows him his secret number <em>S</em>.</li><li>Now Victor can prove to Alice he transferred the money and successfully receive transaction <em>AV</em>.</li></ol><p>There are couple of scenarios possible.</p><ol><li>First, it does not make sense for Victor to cheat. By design, if he does not pass the money to Bob, he will not get the money from Alice.</li><li>But Bob can decide to cheat and not to reveal the secret key to Victor. To get the money Bob will need to close the channel with Victor and to submit transaction <em>VB</em> to the blockchain. <em>But</em> to actually spend the money, Bob will need to show his secret number anyway. And as the blockchain is public, Victor will also see it.</li></ol><p>There is a couple of non-trivial technicalities with selecting the right timeframe for Alice, Victor and Bob to resolve possible conflicts. But these technicalities are way out of scope of this introductory article. If interested — google <em>Hash Time-Locked Contracts (HTLCs)</em>.</p><h2 id=42-routing>4.2. Routing
<a class=anchor href=#42-routing>#</a></h2><p>In practice Alice and Bob can be connected through any arbitrary number of unknown/anonymous intermediaries across the whole world. The problem of finding the most optimal path of intermediaries in a graph of network nodes is called a <em>routing problem</em>.</p><div class=imageWrapper><img src=/img/mln-854.png><p><em>Geographical distribution of bitcoin testnet nodes (<a href=https://explorer.acinq.co/#/>https://explorer.acinq.co/#/</a>).</em></p></div><p>The routing problem is in fact an area of active research at the moment. Optimal path depends on many dynamic factors: the availability of nodes, network topology, channels throughput, intermediaries fees.</p><p>Without going into too many details, finding the path and passing the payments in LN is currently done based on <a href=https://en.wikipedia.org/wiki/Onion_routing><em>Onion routing</em></a> <em>—</em> a technology for anonymous peer-to-peer routing, which is also used, for example, in <a href=https://www.torproject.org/>Tor</a>.</p><p>Everything is decentralized, the traffic is encrypted. No intermediary knows from whom the bitcoins come and where they go. One more advantage follows from this.</p><blockquote class="book-hint btc"><em><strong>👍 Advantages:</strong> Lightning Network is much more anonymous than bitcoin itself. First, an absolute majority of the transactions are never recorded in a public ledger, these transactions are only visible to a handful of nodes. Second, even among the nodes involved in routing, only the first and the last node knows the source and the destination of the payment.</em></blockquote><h2 id=43-fees-economy>4.3. Fees economy
<a class=anchor href=#43-fees-economy>#</a></h2><p>Only two major questions left.</p><p><strong>Question number 1:</strong> why would an intermediary node process any payments from someone else?</p><p>First of all, because good connectivity allows them to use LN more efficiently. Second, because they receive fee: usually <em>very small</em>, but motivational enough.</p><p>At the moment the network is mostly supported by enthusiasts and the fees are almost zero: 1 satoshi, or ~0.01 <em>cents</em> for every intermediary node.</p><blockquote class="book-hint btc"><em>👍 The “bandwidth” of payment channels is a much less valuable resource than the block size. Channels are cheap and easy to open. Because of that fees in LN are orders of magnitude smaller than the fees in the main bitcoin blockchain.</em></blockquote><p><strong>Question number 2:</strong> and what about the miner fees payed on the main blockchain to open/close payment channels?</p><p>Indeed, these fees can be quite large, reaching sometimes tens of dollars. Therefore, payments are going to be cheaper if the channels are open/closed rarely.</p><p>This in turn motivates people to open channels with larger deposits, and to use channels bi-directionally: not only for outgoing payments, but also for incoming ones.</p><p><em>Example</em>: I open a channel and fund it with 1000 dollars to use it for only outgoing payments. The turnover in the channel over the lifetime will be exactly 1000 dollars, and I will pay ~20 dollars in fees to open and close the channel. This results in 2% fees. Slightly lower than visa and mastercard, but still not as low as I would like.</p><p>The situation changes dramatically when the I start using Lightning to the fullest: deposit larger amounts and also start receiving money through channels. Then, depending on the proportion of spent/received money, <em>the channel can be open forever and the fees will be converging to almost zero in the limit</em>.</p><h2 id=44-criticism>4.4. Criticism
<a class=anchor href=#44-criticism>#</a></h2><p>It is easy to find lots of criticism of second layer solutions in general and of Lightning Network in particular. Some points actually deserve attention, some are outdated myths. Here is a couple of examples.</p><blockquote><p><em>1. Using LN leads to centralization: users benefit from connecting to large hubs, and few of these hubs can control all the traffic.</em></p></blockquote><p>This is a valid concern and deserves attention, but the risks are not huge. First, it is economically profitable and very simple to run a new node bypassing large hubs. Second, routing algorithms should balance the traffic among all the possible paths. And third, at least for the moment we <a href=https://lnmainnet.gaben.win/>do not see this centralization happening</a>. Going forward, I hope the optimal topology is going to be encouraged by wallet software itself.</p><blockquote><p><em>2. Low channel throughput will result in LN congestion, fees rising, and the situation will be as bad as in the main bitcoin blockchain.</em></p></blockquote><p>Again, as soon as this starts happening, people will have larger economic incentives to run their own nodes. Unlike the block size, the number of nodes/channels is almost unlimited.</p><blockquote><p><em>3. Efficient and effective routing on large number of peer-to-peer nodes is impossible. Especially when accounting the cost of opening new channels.</em></p></blockquote><p>These problems are <em>far-far-far</em> into the future. But the research in this direction is already happening (<a href=http://bitfury.com/content/5-white-papers-research/whitepaper_flare_an_approach_to_routing_in_lightning_network_7_7_2016.pdf>example</a>). The community will come up with something.</p><blockquote><p><em>4. Channels need to be often opened and closed. Fees spent on that will be high, and LN will become more and more expensive.</em></p></blockquote><p>Actually, this is an outdated myth still circling around. Early proposals of payments channels indeed were uni-directional and could last only for a fixed time. Now these problems are both solved.</p><blockquote><p><em>5. You need to be online to use LN.</em></p></blockquote><p>Partly true. Unlike early LN implementations, there is no need to be always online: other participants can monitor my open channels and verify that no one is cheating. But you indeed need to be online to send/receive money. This is of course a limitation, but a much less significant one.</p><blockquote><p><em>6. LN is not compatible with cold storage.</em></p></blockquote><p>This is a very good point and valid concern. Funds locked in payment channels are controlled by the wallets being online (<em>hot wallets</em>). So additional security for nodes will be required to protect against hackers.</p><blockquote><p><em>7. LN transactions are not as safe as on-chain transactions.</em></p></blockquote><p>LN payments are indeed more risky than on-chain transactions. But only <a href=https://blog.bitmex.com/the-lightning-network/>in case of a successful 51% attack</a>. The risk of it is very-very small.</p><h1 id=5-ln-today>5. LN today
<a class=anchor href=#5-ln-today>#</a></h1><p>The most important thing you need to know: Lightning is already here and it really works.</p><p><a href=https://explorer.acinq.co/#/>More than a thousand nodes</a> in bitcoin testnet and <a href=https://lnmainnet.gaben.win/>more then three hundred nodes</a> (growing every day) in mainnet are already processing transactions and testing different software today.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Bug testing should be on testnet, not mainnet. Especially when the devs are still losing money. 🙃 <a href=https://t.co/QYx94V0vpR>https://t.co/QYx94V0vpR</a></p>&mdash; elizabeth stark ⚡ (@starkness) <a href="https://twitter.com/starkness/status/953434418948927488?ref_src=twsrc%5Etfw">January 17, 2018</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p><em>Co-founder of Lightning Labs does not recommend running mainnet nodes for the moment.</em></p><p>As for software, there are three main implementation: <a href=https://github.com/lightningnetwork/lnd>lnd</a> from <em>Lightning Labs</em>, <a href=https://github.com/ElementsProject/lightning>c-lightning</a> from <em>Blockstream</em>, <a href=https://github.com/ACINQ/eclair>eclair</a> from <em>ACINQ</em>. These teams have been working for years to create standard specifications for nodes interactions called <a href=https://github.com/lightningnetwork/lightning-rfc><em>Lightning Network Specifications (BOLTs)</em></a>. And recently, in the end of 2016, they performed massive successful payment testing. All three implementations proved to be compatible.</p><p>At the moment, you can pay with real bitcoins using LN in only three or four online shops. But this is a whole three or four shops more than just a month ago, so this is already a great success 😊</p><p>Of course, the moment of ubiquitous transition from <em>on-chain</em> bitcoin payments to <em>off-chain</em> payments is still far away. A huge work should still be carried out by developers of wallets, payment gateways, exchanges, online stores. And, of course, by users themselves.</p><p>The most interesting in this story is that faster, cheaper and more anonymous transactions — is only the beginning of the story! Soon we will see even more anonymity, atomic swaps, decentralized exchanges and many more cool things. The future is exciting! ⚡</p><p><em>More technical details about LN:</em> <a href=https://lightning.network/lightning-network-paper.pdf><em>1</em></a><em>,</em> <a href=https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki><em>2</em></a><em>,</em> <a href=https://github.com/lightningnetwork/lightning-rfc><em>3</em></a><em>,</em> <a href=https://github.com/ElementsProject/lightning/blob/master/doc/deployable-lightning.pdf><em>4</em></a><em>,</em> <a href=https://blog.bitmex.com/the-lightning-network/><em>5</em></a><em>.</em></p><hr><p>Please do comment, criticize, ask questions, subscribe. More about the author: <a href=http://laptev.ch>http://laptev.ch</a>.</p></article><hr><i>Connect to our relay to leave a comment. <a href=https://21ideas.org/en/comments/>Details</a>.<br>Подключитесь к нашему релею, чтобы оставить комментарий. <a href=https://21ideas.org/comments/>Подробнее</a>.</i>
<zap-threads anchor=https://21ideas.org/en/lightning-network-explained/ author=npub1lm3f47nzyf0rjp6fsl4qlnkmzed4uj4h2gnf2vhe3l3mrj85vqks6z3c7l relays=wss://21ideas.nostr1.com disable=replyAnonymously legacy-url=true></zap-threads><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#0-why>0. Why?</a></li><li><a href=#1-idea>1. Idea</a><ul><li><a href=#11-payment-channel>1.1. Payment channel</a></li><li><a href=#12-network-of-payment-channels>1.2. Network of payment channels</a></li><li><a href=#13-the-problem-of-trust>1.3. The problem of trust</a></li></ul></li><li><a href=#2-smart-contracts>2. Smart contracts</a><ul><li><a href=#21-authorisation>2.1. Authorisation</a></li><li><a href=#22-cooperation>2.2. Cooperation</a></li><li><a href=#23-timing>2.3. Timing</a></li></ul></li><li><a href=#3-payment-channel-implementation>3. Payment channel implementation</a><ul><li><a href=#31-opening-the-channel>3.1. Opening the channel</a></li><li><a href=#32-using-the-channel>3.2. Using the channel</a></li></ul></li><li><a href=#4-lightning-network>4. Lightning Network</a><ul><li><a href=#41-payment-channel-though-an-intermediary>4.1. Payment channel though an intermediary</a></li><li><a href=#42-routing>4.2. Routing</a></li><li><a href=#43-fees-economy>4.3. Fees economy</a></li><li><a href=#44-criticism>4.4. Criticism</a></li></ul></li><li><a href=#5-ln-today>5. LN today</a></li></ul></nav></div></aside></main><script>"use strict";const METRICS={FEE:"fee",BLOCK:"block",PRICE:"price",SATS:"sats",BTC:"btc"};let currentMetric=METRICS.FEE,lastKnownValues={fee:{label:"Комиссия",value:"0 sat/vB"},block:{label:"Высота блока",value:"0"},price:{label:"Цена",value:"$0"},sats:{label:"Московское время",value:"00:00"},btc:{label:"",value:"1 BTC = 1 BTC"}};function formatSatsAsTime(e){const t=Math.round(e).toString().padStart(4,"0"),n=t.slice(0,-2),s=t.slice(-2);return`${n}:${s}`}function formatNumber(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function updateDisplay(){const n=document.getElementById("metrics-label"),e=document.getElementById("metrics-value");if(!n||!e)return;const t=lastKnownValues[currentMetric];n.textContent=t.label,e.textContent=t.value,e.style.paddingTop=t.label?"0":"0.7rem"}async function updateMetrics(){try{const[t,n,e]=await Promise.all([fetch("https://mempool.space/api/v1/fees/recommended").then(e=>e.json()),fetch("https://mempool.space/api/blocks/tip/height").then(e=>e.json()),fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd").then(e=>e.json())]);lastKnownValues.fee.value=`${t.fastestFee} sat/vB`,lastKnownValues.block.value=formatNumber(n),lastKnownValues.price.value=`$${formatNumber(e.bitcoin.usd)}`;const s=Math.round(1e8/e.bitcoin.usd);lastKnownValues.sats.value=formatSatsAsTime(s),updateDisplay()}catch(e){console.error("Error fetching metrics:",e)}}function cycleMetric(){const e=Object.values(METRICS),t=e.indexOf(currentMetric);currentMetric=e[(t+1)%e.length],updateDisplay()}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("metrics-container");e&&(e.addEventListener("click",cycleMetric),updateMetrics(),setInterval(updateMetrics,6e4))})</script></body></html>