<!doctype html><html lang=ru-RU dir=ltr><head><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel=stylesheet><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Из этой статьи вы узнаете о принципе работы протоколов BIP47 и PayNym, механизмах работы этих протоколов и практических приложениях, которые из них вытекают."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta name=lightning content="21ideas@getalby.com"><meta property="og:title" content="BIP47, или гадкий утенок"><meta property="og:description" content="Из этой статьи вы узнаете о принципе работы протоколов BIP47 и PayNym, механизмах работы этих протоколов и практических приложениях, которые из них вытекают."><meta property="og:type" content="article"><meta property="og:url" content="https://21ideas.org/bip47-ili-gadkij-utenok/"><meta property="og:image" content="https://21ideas.org/img/bip47-ili-gadkij-utenok/ugly-987.webp"><title>BIP47, или гадкий утенок | 21ideas</title><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon media="(prefers-color-scheme: dark)" sizes=180x180 href=/apple-touch-icon-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=32x32 href=/favicon-32x32-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=16x16 href=/favicon-16x16-dark.png><link rel=alternate hreflang=en href=https://21ideas.org/en/bip47-the-ugly-duckling/ title="BIP47, the ugly duckling"><link rel=stylesheet href=/book.min.44d288673620af09aba4fb7b29ef4c1d1f9c0258f725bd228507764ec1740f0a.css integrity="sha256-RNKIZzYgrwmrpPt7Ke9MHR+cAlj3Jb0ihQd2TsF0Dwo=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/ru.search.min.9bcf882f592703b859c8dbb070434bfdadcc7266ffb502e6c674c3149d70d9d9.js integrity="sha256-m8+IL1knA7hZyNuwcENL/a3Mcmb/tQLmxnTDFJ1w2dk=" crossorigin=anonymous></script>
<script type=text/javascript src=https://unpkg.com/zapthreads@0.5.2/dist/zapthreads.iife.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><picture><source srcset=/svg/logo_white.svg media="(prefers-color-scheme: dark)"><img src=/svg/logo_black.svg alt=Logo></picture>
<span>21ideas</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Поиск aria-label=Поиск maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Русский</a></label><ul><li><a href=https://21ideas.org/en/bip47-the-ugly-duckling/>English</a></li></ul></li></ul><ul><li><input type=checkbox id=section-512cd8dd047d9194f8b56568c3c961b4 class=toggle>
<label for=section-512cd8dd047d9194f8b56568c3c961b4 class="flex justify-between"><a href=/start/>Старт</a></label><ul><li><a href=/glossary/>Глоссарий</a></li><li><a href=/start/start/>Что такое Биткоин?</a></li><li><a href=/start/guide/>Используем биткоин</a></li><li><a href=/course/>Биткоин от А до Я</a></li><li><a href=/bitcoin-myths/>Разрушаем мифы о Биткоине</a></li><li><a href=/shitcoin-casino/>Не играйте в щиткоин-казино</a></li></ul></li><li><input type=checkbox id=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class=toggle checked>
<label for=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class="flex justify-between"><a href=/theory/>Теория</a></label><ul><li><input type=checkbox id=section-c4ddad175f26bb1d35909363eff62296 class=toggle>
<label for=section-c4ddad175f26bb1d35909363eff62296 class="flex justify-between"><a href=/economics/>Экономика</a></label><ul><li><input type=checkbox id=section-182005e73bd80d066a67724ac5ed0bad class=toggle>
<label for=section-182005e73bd80d066a67724ac5ed0bad class="flex justify-between"><a href=/pzv/>Постепенно, затем внезапно</a></label><ul><li><a href=/pzv/postepenno-zatem-vnezapno/>Введение</a></li><li><a href=/pzv/bitkoin-nelzya-skopirovat/>Биткоин нельзя скопировать</a></li><li><a href=/pzv/bitkoin-ne-slishkom-volatilen/>Биткоин не слишком волатилен</a></li><li><a href=/pzv/bitkoin-ne-tratit-energiyu-zrya/>Биткоин не тратит энергию зря</a></li><li><a href=/pzv/bitkoin-ne-slishkom-medlennyj/>Биткоин не слишком медленный</a></li><li><a href=/pzv/bitkoin-eto-ispravit/>Биткоин это исправит</a></li><li><a href=/pzv/bitkoin-ne-blokchejn/>Биткоин, не блокчейн</a></li><li><a href=/pzv/bitkoin-nichem-ne-podkreplen/>Биткоин ничем не подкреплен?</a></li><li><a href=/pzv/bitkoin-ne-finansovaya-piramida/>Биткоин — не финансовая пирамида</a></li><li><a href=/pzv/bitkoin-ne-mozhet-byt-zabanen/>Биткоин не может быть забанен</a></li><li><a href=/pzv/bitkoin-ne-dlya-prestupnikov/>Биткоин не для преступников</a></li><li><a href=/pzv/bitkoin-obescenivaet-ostalnye-dengi/>Биткоин обесценивает остальные деньги</a></li><li><a href=/pzv/bitkoin-zov-k-edineniyu/>Биткоин — зов к единению</a></li><li><a href=/pzv/bitkoin-eto-zdravyj-smysl/>Биткоин — это здравый смысл</a></li><li><a href=/pzv/bitkoin-antihrupok/>Биткоин антихрупок</a></li><li><a href=/pzv/bitkoin-velikaya-definancializaciya/>Биткоин — великая дефинанcиализация</a></li></ul></li><li><input type=checkbox id=section-7f9a42e8b73c082c7ee1415fd0eae7fb class=toggle>
<label for=section-7f9a42e8b73c082c7ee1415fd0eae7fb class="flex justify-between"><a href=/sb/>Становление Биткоина</a></label><ul><li><a href=/sb/stanovlenie-intro/>Введение</a></li><li><a href=/sb/stanovlenie-1/>О времени</a></li><li><a href=/sb/stanovlenie-2/>О людях</a></li><li><a href=/sb/stanovlenie-3/>Знакомьтесь: деньги</a></li><li><a href=/sb/stanovlenie-4/>Поворот не туда</a></li><li><a href=/sb/stanovlenie-5/>Цифровая редкость</a></li><li><a href=/sb/stanovlenie-6/>Цифровые контракты</a></li><li><a href=/sb/stanovlenie-7/>Недостающие части головоломки</a></li></ul></li><li><a href=/bitkoin-ne-vredit-okruzhayushej-srede/>Биткоин и окружающая среда</a></li><li><a href=/sem-setevyh-effektov-bitkoina/>Семь сетевых эффектов Биткоина</a></li><li><a href=/hozyaeva-i-raby-deneg/>Хозяева и рабы денег</a></li><li><a href=/strukturnaya-perestrojka/>Структурная перестройка</a></li><li><a href=/v-zashchitu-deflyacii/>В защиту дефляции</a></li><li><a href=/sravnenie-monetarnyh-standartov/>Сравнение монетарных стандартов</a></li><li><a href=/negativnye-effekty-neftedollara/>Негативные внешние эффекты нефтедоллара</a></li><li><a href=/raskoshelivaemsya/>Раскошеливаемся (Shelling Out): Происхождение денег</a></li><li><a href=/bitcoin-i-ritmy-istorii/>Биткоин и ритмы истории</a></li><li><a href=/bitcoin-i-internet-cikly-hopfa/>Биткоин и интернет-циклы Хопфа</a></li><li><a href=/dengi-blokchejny-i-socialnaya-masshtabiruemost/>Деньги, блокчейны и социальная масштабируемость</a></li><li><a href=/chto-takoe-dengi/>Что такое деньги</a></li><li><a href=/vyzhivaet-silnejshij/>Выживает сильнейший</a></li><li><a href=/strategiya-dca/>Стратегия DCA</a></li><li><a href=/jevons-paradox/>Парадокс Джевонса: Обратная истина</a></li><li><a href=/kak-rabotajut-dengi/>Как работают деньги</a></li></ul></li><li><input type=checkbox id=section-e83ea293497a2ab861101ccfc99a8ecc class=toggle>
<label for=section-e83ea293497a2ab861101ccfc99a8ecc class="flex justify-between"><a href=/security/>Безопасность</a></label><ul><li><a href=/kak-hranit-kljuchi/>Биткоин-кошельки. Зачем и как хранить свои приватные ключи</a></li><li><a href=/seed/>Что такое сид-фраза?</a></li><li><a href=/seed-security/>Как обезопасить свои сид-фразы?</a></li><li><a href=/passphrase/>Насколько надежна ваша парольная фраза?</a></li><li><a href=/multisig/>Все о мультисиг</a></li><li><a href=/hwws/>Сравнение аппаратных кошельков</a></li><li><a href=/multisig-1/>Мультисиг. Часть I</a></li><li><a href=/multisig-2/>Мультисиг. Часть II: Отдельные ключи – основа мультиподписи</a></li></ul></li><li><input type=checkbox id=section-e9552bdc5e196adcf41f88d9180bebda class=toggle checked>
<label for=section-e9552bdc5e196adcf41f88d9180bebda class="flex justify-between"><a href=/privacy/>Приватность</a></label><ul><li><a href=/privacy/luchshie-praktiki/>Как сохранить приватность?</a></li><li><a href=/privacy/no-kyc/>Никаких KYC, берегите персональные данные</a></li><li><a href=/privatnost-v-seti-bitcoin/>Приватность в сети Биткоин</a></li><li><a href=/bitcoin-stanovitsya-kriticheski-vazhnym/>Биткоин становится критически важным</a></li><li><a href=/bip47-ili-gadkij-utenok/ class=active>BIP47, или гадкий утенок</a></li><li><input type=checkbox id=section-197d372e28cf8111d6d38339599c8c1f class=toggle>
<label for=section-197d372e28cf8111d6d38339599c8c1f class="flex justify-between"><a href=/privacy/oxt/>Понимание приватности в сети Биткоин с помощью OXT</a></label><ul><li><a href=/privacy/oxt-1/>Часть 1: Анализ цепочки и приватность транзакций</a></li><li><a href=/privacy/oxt-2/>Часть 2: Ключевые концепции анализа цепочки</a></li><li><a href=/privacy/oxt-3/>Часть 3: Защита от анализа цепочки</a></li><li><a href=/privacy/oxt-4/>Часть 4: Применение концепций анализа цепочки для улучшения приватности пользователей</a></li></ul></li><li><a href=/privacy/coinjoin/>Понимание и использование CoinJoin</a></li><li><a href=/bitcoin-fungibility/>Взаимозаменяемость Биткоина</a></li><li><a href=/freesamourai/>#FreeSamourai</a></li></ul></li><li><input type=checkbox id=section-e49feff8bdc4c8d9840548f297831fbc class=toggle>
<label for=section-e49feff8bdc4c8d9840548f297831fbc class="flex justify-between"><a href=/protocol/>Протокол</a></label><ul><li><a href=/kto-kontroliruet-bitkoin-kor/>Кто контролирует Bitcoin Core?</a></li><li><a href=/vechnaja-borba/>Вечная борьба Биткоина</a></li><li><a href=/ob-udobstve-vzaimodejstvija-s-bitcoinom/>Об удобстве взаимодействия с Биткоином</a></li><li><a href=/bitcoin-zoloto-2-0/>Биткоин: цифровое золото или пиринговая наличность?</a></li><li><a href=/upravlenie-bitcoin/>Управление Биткоином</a></li><li><a href=/doverennye-tretyi-storony/>Доверенные третьи стороны — это бреши в системе безопасности</a></li><li><a href=/21-million-ne-podlezhit-obsuzhdeniyu/>21 миллион не подлежит обсуждению</a></li><li><a href=/proof-of-work/>Proof of Work: доказательство проделанной работы</a></li><li><a href=/proof-of-stake-eto-skam/>Proof of Stake – это скам</a></li><li><a href=/byl-li-satoshi-zhadnym-majnerom/>Был ли Сатоши жадным майнером?</a></li><li><a href=/segwit/>Что такое SegWit</a></li><li><a href=/taproot/>Что такое Taproot</a></li><li><a href=/bomby-slozhnosti-ethereum/>Бомбы сложности Ethereum</a></li><li><a href=/rgb/>Разбирая протокол RGB</a></li><li><a href=/halving/>Что такое Биткоин-халвинг?</a></li><li><a href=/difficulty/>О корректировке сложности майнинга</a></li><li><a href=/sravnenie-tipov-bitcoin-adresov/>Типы биткоин-адресов</a></li><li><a href=/myths-about-halving/>Мифы о Биткоин-халвинге</a></li><li><a href=/mining-walkthrough/>SHA256 и майнинг в сети Биткоин</a></li><li><input type=checkbox id=section-84ceb72b1632e17a773889af11eec517 class=toggle>
<label for=section-84ceb72b1632e17a773889af11eec517 class="flex justify-between"><a href=/protocol/utxo/>Что такое UTXO и как ими управлять?</a></label><ul><li><a href=/protocol/utxo-1/>Что такое UTXO?</a></li><li><a href=/protocol/utxo-2/>Как избежать высоких комиссий при большом количестве UTXO</a></li><li><a href=/protocol/utxo-3/>Приватность UTXO</a></li></ul></li><li><a href=/timestamps/>Временны́е метки в Биткоине</a></li><li><a href=/transaction-size/>Размер транзакции</a></li><li><a href=/o-zakostenenii-protokola/>О закостенении протокола</a></li></ul></li><li><input type=checkbox id=section-8509d6019544d659ccbc67af32e91aea class=toggle>
<label for=section-8509d6019544d659ccbc67af32e91aea class="flex justify-between"><a href=/history/>История</a></label><ul><li><input type=checkbox id=section-aa23c48a9c39058e09f0c1d84d8ebaca class=toggle>
<label for=section-aa23c48a9c39058e09f0c1d84d8ebaca class="flex justify-between"><a href=/gf/>Генезис-файлы</a></label><ul><li><a href=/gf/genesis-intro/>Пролог</a></li><li><a href=/gf/genesis-1/>Часть I: eCash Дэвида Чаума и зарождение мечты шифропанков</a></li><li><a href=/gf/genesis-2/>Часть II: Hashcash или как Адам Бэк разработал сердце Биткоина</a></li><li><a href=/gf/genesis-3/>Часть III: Если у Биткоина был прототип, то это были b-money Вэя Дая</a></li><li><a href=/gf/genesis-4/>Часть IV: Создавая Bit Gold, Сабо был в двух шагах от изобретения Биткоина</a></li><li><a href=/gf/genesis-5/>Часть V: Как поиски цифровой наличности привели Хэла Финни к созданию RPOW (и не только)</a></li></ul></li><li><a href=/hal-finney/>Хэл Финни — жизнь и смерть легенды движения шифропанков</a></li><li><a href=/bitcoin-and-me/>Биткоин и я</a></li><li><a href=/bitcoin-reformaciya/>Биткоин-Реформация</a></li><li><a href=/bitcoin-forks/>Полная история консенсус-форков Биткоина</a></li><li><a href=/analyzing-2013-fork/>Анализ форка Биткоина 2013 года</a></li><li><input type=checkbox id=section-6413681172093090da410a6853c081ef class=toggle>
<label for=section-6413681172093090da410a6853c081ef class="flex justify-between"><a href=/sr/>Silk Road</a></label><ul><li><a href=/sr/silkroad-1/>Скаут, Биткоин и грибы</a></li><li><a href=/sr/silkroad-2/>Первые успехи и неудачи нарко-Amazon'a</a></li><li><a href=/sr/silkroad-3/>Ужасный Пират Робертс</a></li><li><a href=/sr/silkroad-4/>Компания, заработавшая тысячи биткоинов</a></li><li><a href=/sr/silkroad-5/>Тёмная сторона Silk Road</a></li><li><a href=/sr/silkroad-6/>Розыск и арест Росса Ульбрихта</a></li></ul></li></ul></li><li><input type=checkbox id=section-042f7e1a0906e66d4ceaeeb231b37175 class=toggle>
<label for=section-042f7e1a0906e66d4ceaeeb231b37175 class="flex justify-between"><a href=/philosophy/>Философия</a></label><ul><li><input type=checkbox id=section-1048f9a65fd469c32ebe9f1814dc2a1c class=toggle>
<label for=section-1048f9a65fd469c32ebe9f1814dc2a1c class="flex justify-between"><a href=/chemu-ya-nauchilsya-u-bitcoina/>Чему я научился у Биткоина?</a></label><ul><li><a href=/chemu-ya-nauchilsya-u-bitcoina/filosofskie-uroki-bitcoina/>Часть1. Философские уроки Биткоина</a></li></ul></li><li><a href=/ne-shitcoin/>Биткоин, не щиткоин</a></li><li><a href=/neotemlemye-prava-sobstvennosti/>Неотъемлемые права собственности</a></li><li><a href=/manifest-kriptoanarhista/>Манифест криптоанархиста</a></li><li><a href=/manifest-shifropanka/>Манифест шифропанка</a></li><li><a href=/tyulpannaya-lihoradka/>Биткоин — современная голландская тюльпанная лихорадка?</a></li><li><a href=/vse-moshenniki/>Все — мошенники</a></li><li><a href=/svoboda-cennosti/>Свобода ценности</a></li><li><a href=/bitcoin-meme/>Биткоин — единственный реальный мем</a></li><li><a href=/nol-i-bitcoin/>Ноль и Биткоин</a></li><li><a href=/crypto-bro/>Дорогие крипто- и фиат-бро</a></li><li><a href=/boremsya-s-poddelnymi-bitcoin/>Боремся с поддельными биткоинами</a></li><li><a href=/bit%D1%81oin-eto-micelij/>Биткоин — это мицелий</a></li><li><a href=/pochemu-bitcoin-zhivoj-organizm/>Доказательство жизни. Почему Биткоин — живой организм</a></li><li><a href=/samaya-mirnaya-revolyuciya/>Самая мирная революция</a></li><li><a href=/o-bitcoin-vselennoj/>О Биткоин-вселенной</a></li><li><a href=/bitcoin-dissidenty/>Биткоин-диссиденты</a></li><li><a href=/bitcoin-svoboda/>Биткоин = свобода</a></li></ul></li><li><input type=checkbox id=section-66beb9b5ed04619b43509a5a9298b3a2 class=toggle>
<label for=section-66beb9b5ed04619b43509a5a9298b3a2 class="flex justify-between"><a href=/future/>Будущее</a></label><ul><li><input type=checkbox id=section-df24c55b3b01a044f159006399dd3f62 class=toggle>
<label for=section-df24c55b3b01a044f159006399dd3f62 class="flex justify-between"><a href=/ba/>Биткоин-астрономия</a></label><ul><li><a href=/ba/1/>Постгипербиткоинизация</a></li><li><a href=/ba/2/>Миллион крошечных миров</a></li><li><a href=/ba/3/>Первый контакт</a></li></ul></li><li><a href=/ej-bitcoin-pritormozi/>Эй, Биткоин, притормози</a></li><li><a href=/apokalipsis/>Сможет ли Биткоин пережить апокалипсис?</a></li><li><a href=/bitcoin-i-teplovaya-energiya-okeanov/>Биткоин и тепловая энергия океанов</a></li></ul></li><li><input type=checkbox id=section-a71a3aee31fa8f939d269196bdc16bfd class=toggle>
<label for=section-a71a3aee31fa8f939d269196bdc16bfd class="flex justify-between"><a href=/lightning/>Лайтнинг</a></label><ul><li><a href=/chto-takoe-laitning/>Что такое Лайтнинг?</a></li><li><a href=/lajtning-koshelki/>Лайтнинг-кошельки</a></li><li><a href=/lajtning-adresa/>Лайтнинг-адреса</a></li><li><a href=/privatnost-v-lajtning/>Приватность в сети Lightning</a></li><li><a href=/centralizovanna-li-set-lightning/>Централизованна ли сеть Lightning?</a></li><li><a href=/mekhanizm-raboty-lightning/>Механизм работы Lightning Network</a></li><li><a href=/problema-vhodyashchej-likvidnosti/>Решение проблемы входящей ликвидности</a></li></ul></li></ul></li><li><input type=checkbox id=section-a6b5e5f811434cb992fdebac0e1d7718 class=toggle>
<label for=section-a6b5e5f811434cb992fdebac0e1d7718 class="flex justify-between"><a href=/practice/>Практика</a></label><ul><li><input type=checkbox id=section-5a7a56ff2c706814b0747555f55b45b2 class=toggle>
<label for=section-5a7a56ff2c706814b0747555f55b45b2 class="flex justify-between"><a href=/practice/buy/>Покупка</a></label><ul><li><a href=/newbie-buy/>Покупка и хранение биткоина для новичков</a></li><li><a href=/hodl-hodl/>Покупка биткоина без KYC на Hodl Hodl</a></li><li><a href=/robosats/>RoboSats: Приватный p2p обмен</a></li></ul></li><li><input type=checkbox id=section-a2a499e8fa40193bb85003cabaff5d49 class=toggle>
<label for=section-a2a499e8fa40193bb85003cabaff5d49 class="flex justify-between"><a href=/practice/hodl/>Хранение</a></label><ul><li><a href=/electrum/>Кошелек Электрум</a></li><li><a href=/blue/>Кошелек Blue</a></li><li><a href=/seedsigner/>SeedSigner: оффлайн-крепость для ваших биткоинов</a></li><li><a href=/holodnyj-koshelek-iz-starogo-smartfona/>Холодный кошелек из старого смартфона</a></li><li><a href=/coldcard/>Что такое Coldcard?</a></li></ul></li><li><input type=checkbox id=section-4e34fd6dae27eeab9274b5e370a300a7 class=toggle>
<label for=section-4e34fd6dae27eeab9274b5e370a300a7 class="flex justify-between"><a href=/practice/interact/>Взаимодействие</a></label><ul><li><a href=/practice/bitcoin-node/>Каждому следует запустить собственную Биткоин-ноду!</a></li><li><a href=/orangepilling-in-5-min/>Оранжпиллинг за 5 минут</a></li><li><a href=/5-tips-for-teaching-bitcoin/>5 советов по обучению Биткоину</a></li></ul></li><li><input type=checkbox id=section-96e30ec66d0b34a4f6f9c7ee8d27fdd6 class=toggle>
<label for=section-96e30ec66d0b34a4f6f9c7ee8d27fdd6 class="flex justify-between"><a href=/docs/Practice/security/>Практики безопасности</a></label><ul><li><a href=/pgp-verify/>Проверка подлинности программ с помощью PGP</a></li></ul></li><li><input type=checkbox id=section-ed813fe32867bdad9fbc116cfa115400 class=toggle>
<label for=section-ed813fe32867bdad9fbc116cfa115400 class="flex justify-between"><a href=/practice-privacy/>Практики приватности</a></label><ul><li><input type=checkbox id=section-20fa42a588c7405850eac56c7752c25b class=toggle>
<label for=section-20fa42a588c7405850eac56c7752c25b class="flex justify-between"><a href=/practice-privacy/dojo/>Установка Биткоин-узла Dojo на x86</a></label><ul><li><a href=/practice-privacy/dojo-0/>Введение</a></li><li><a href=/practice-privacy/dojo-1/>Установка Bitcoin Core и Tor</a></li><li><a href=/practice-privacy/dojo-2/>Установка индексатора Fulcrum</a></li><li><a href=/practice-privacy/dojo-3/>Установка блокчейн-обозревателя Mempool</a></li><li><a href=/practice-privacy/dojo-4/>Установка Samourai Dojo</a></li><li><a href=/practice-privacy/dojo-5/>Конфигурация межсетевого экрана</a></li><li><a href=/practice-privacy/dojo-6/>Установка обновлений пакетов</a></li></ul></li><li><a href=/practice-privacy/ronindojo/>Установка RoninDojo на x86</a></li><li><a href=/grapheneos/>GrapheneOS: Избавляемся от слежки Google на смартфоне</a></li></ul></li><li><input type=checkbox id=section-0af442a82e8087438ae3e5d932bfcd3c class=toggle>
<label for=section-0af442a82e8087438ae3e5d932bfcd3c class="flex justify-between"><a href=/practice/lightning/>Лайтнинг на практике</a></label><ul><li><a href=/phoenix/>Кошелек Phoenix</a></li><li><a href=/lnbits/>LNbits – швейцарский нож среди лайтнинг-приложений</a></li><li><a href=/alby-i-nostr/>Alby и Nostr</a></li><li><a href=/zapplanner/>Подписки с помощью Лайтнинг</a></li><li><a href=/lntips/>Телеграм-бот @LightningTipBot</a></li><li><a href=/ochishchaem-bitcoin-cherez-lajtning/>Очищаем биткоины через сеть Лайтнинг</a></li><li><a href=/likvidnost-v-lajtning/>Руководство по управлению ликвидностью в сети Lightning</a></li><li><a href=/mutiny/>Кошелек Mutiny</a></li></ul></li></ul></li><li><input type=checkbox id=section-4f9efbc916a788429edff50248f79330 class=toggle>
<label for=section-4f9efbc916a788429edff50248f79330 class="flex justify-between"><a href=/rabbithole/>Кроличья нора</a></label><ul><li><a href=/books/>Книги</a><ul></ul></li><li><a href=/videos/>Видео</a><ul></ul></li><li><a href=/audiobooks/>Аудиокниги</a><ul></ul></li><li><a href=/pods/>Подкасты</a><ul></ul></li></ul></li></ul><div class=menuSep></div><ul><li><a href=/posts/>Блог</a></li><li><a href=/calendar/>Биткоин-календарь</a></li><li><input type=checkbox id=section-d90442343f58c582906ebc7e255e7116 class=toggle>
<label for=section-d90442343f58c582906ebc7e255e7116 class="flex justify-between"><a href=/contribute/>Принять участие</a></label><ul><li><a href=/syntax/>Оформление статей</a></li><li><a href=/github/>Как добавить статью?</a></li><li><a href=/obsidian/>Публикация статей через Obsidian</a></li></ul></li><li><a href=/feedback/>Обратная связь</a></li></ul></nav><footer><br><a class=menuSocialButton href=https://t.me/bitcoin21ideas target=_blank title=Telegram><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg"><path d="m12 0C5.373.0.0 5.373.0 12s5.373 12 12 12 12-5.373 12-12c0-6.627-5.373-12-12-12zm5.894 8.221-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002.0-.003.0-.005.0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121L8.32 13.617l-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/></svg></a>&nbsp;
<a class=menuSocialButton href=https://github.com/21ideas-org/21ideas.org target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 820 820"><path d="M4e2 9.9C179.11 9.9.0 189 0 409.94.0 585.6 113.24 734.86 270.71 788.61l2.83.83c20 3.76 27.34-8.59 27.34-19.24.0-9.49-.32-34.68-.5-68-111.27 24.14-134.75-53.68-134.75-53.68a106.58 106.58.0 00-44.09-58.26l-.43-.24c-36.23-24.81 2.8-24.3 2.8-24.3A84.06 84.06.0 01185 606.54l.22.4a85.24 85.24.0 00116.92 33l-.43.21A85.16 85.16.0 01327 586.7C238.19 576.67 144.8 542.25 144.8 389c0-.72.0-1.55.0-2.38a153.82 153.82.0 0141.27-105l-.08.11a139.82 139.82.0 01-8.56-48.58 141.91 141.91.0 0112.4-58.21l-.37.91s33.51-10.72 110 41c30-8.56 64.43-13.5 1e2-13.5a378.09 378.09.0 01102.68 14.14l-2.67-.64c76-51.72 109.51-41 109.51-41a144 144 0 0112 58.07 145.56 145.56.0 01-8.35 48.82l.32-1a154.37 154.37.0 0141 105c0 .83.0 1.63.0 2.43V389c0 153.68-93.5 187.51-182.52 197.35a95.48 95.48.0 0127.27 66.93c0 2.48-.11 5-.3 7.42v-.32c0 53.54-.51 96.54-.51 109.53.0 10.51 7 23 27.51 19C686.25 734.78 8e2 585.39 8e2 409.41 8e2 188.74 621.11 9.87 400.47 9.87H4e2z"/></svg></a>&nbsp;
<a class=menuSocialButton href=https://njump.me/npub1lm3f47nzyf0rjp6fsl4qlnkmzed4uj4h2gnf2vhe3l3mrj85vqks6z3c7l target=_blank title=Nostr><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 820 820"><path d="M4e2 797.5c219.53.0 397.5-178 397.5-397.5S619.53 2.5 4e2 2.5 2.5 180.47 2.5 4e2 180.47 797.5 4e2 797.5zM598.23 242.15c6.82 8.46 10.35 18.14 11.45 28.86 1.7 16.37-2.68 31.17-11.2 45-14.19 23.62-43.17 39.63-45.85 41-5.42 2.86-7.42 7.12-7.06 13.34s-1.21 37.19-20 50.83c-9.68 7-48.64 16-66.6 19.05a28.61 28.61.0 00-13.18 5.37c-1 .67-2 1.36-3.2 2.06-6.82 4.27-31.23 38-35.31 45.48l10.66-3.27c21.2-6.53 66.85-20.6 69.52-21 9-1.4 15.89 1.22 20.34 7.79 3.63 5.41 7.18 10.81 10.75 16.25.61.94 1.23 1.87 1.85 2.81 1 1.54 2 3.08 2.93 4.62.48.78 1 1.55 1.45 2.32l1.52 2.38c.09.14.19.29.28.45a10.65 10.65.0 011.37 2.83c.24 1 .91 4.14-.92 6.09-1.7 1.77-4.63 1.77-6.21 1.34a15.65 15.65.0 01-5.6-2.8l-2.49-2.13c-2-1.71-5.73-2.56-8.71-2.44-3.41.13-8-1-10.11-2.37-4.2-2.74-5.35-9.56-5.35-9.68a3.51 3.51.0 00-3.72-2.86 18.58 18.58.0 00-6.28 1.15l-.78.25q-15 4.56-29.93 9.24h0l-14.31 4.45c-7.06 2.19-14.12 4.38-21.13 6.69a37.45 37.45.0 00-5.72 2.62c-.43.21-.84.43-1.25.64l-1.24.64h0c-.85.42-1.7.85-2.55 1.34l-.27.15a30.59 30.59.0 01-5.76 2.65c-7.12 2.13-13.39-1-16.32-8.1-1.88-4.63-.18-13.76.86-16.44 5.58-14.35 21.77-39.58 26.28-46.6.75-1.17 1.17-1.83 1.17-1.86-.36-.12-23.25 9.07-27 11.93-10.35 7.86-34.64 26.49-35 28.31A22.75 22.75.0 01331 508.13c-5.66 2.19-9.13 6.7-12.48 11.08.0.0-60.88 83.83-65 88.34l-.68.74c-2.83 3-12.28 13.16-15 18.13-.46.83-1.61 3.27-2.58 5.33-.6 1.26-1.13 2.38-1.38 2.89.0.05-.05.11-.08.17-.59 1.21-1.91 3.9-6.31 3.66s-4.79-6.12-5-9.09v-.4c-.54-6.88 1-13.7 4.63-20.82a6.46 6.46.0 01.31-.58c1-1.8 3.93-7 2.61-11.36s-2.61-11.14-.6-14.61c2.84-4.77 7.62-5.48 13.92-6.41l2.64-.41c5.29-.85 9.13-3.53 12.84-8.88 4.66-6.84 17-24.51 27.65-39.67C293.62 516 3e2 507 302.66 503.09a25.55 25.55.0 003.77-9.08c1.89-9.74 7.85-16.49 18.14-20.7 2.25-.85 43.17-35.06 43.17-39.45.0-3.1-4.45-4.87-7.92-5.78-.48-.12-26.24-6.82-37.92-12.12A88.58 88.58.0 01305 406.41c-7.53-5.54-22.23-3.16-25.3-2.67l-.27.05c-11 1.58-19.12 6.51-28.37 12.78-1.65 1.16-10.05 4.2-14.31 1.77-1.32-.75-2.9-1.6-4.65-2.54-9.16-4.92-22.91-12.31-28.59-20.9-3.11-4.69-2.68-12.42-.49-20.94 7.07-19.73 17.48-28.56 36.77-33.91 11.39-3.95 32.41-5.33 46.84-6.28 2.93-.19 5.59-.37 7.84-.54.12-.05.8-.09 1.94-.18 7-.51 31.32-2.27 49.13-11.39 1.61-.82 3.59-1.92 5.91-3.2 17.67-9.8 55.68-30.86 107.76-29.25 12.95.4 32.15 7.45 49.77 13.93 14.79 5.43 28.46 10.45 36.38 10.79 17.65.73 26.54-1.22 36.77-11.81 2.92-3.05 15.16-29.53 3.59-44a108.64 108.64.0 00-13.94-14.55q-2.28-1.94-4.59-3.85a183.79 183.79.0 01-15.8-14.29c-13.82-14.61-18.09-34.58-11.51-50.17 4.14-10.9 13-15.65 25.63-13.15 6.22 1.24 11.28 5.49 15.95 9.41a73.24 73.24.0 005.84 4.59c3.6 2.38 9.56 3.78 13.46 4.69 4.93 1.16 8.65 4.93 8.4 7.49s-6.7 4.75-13 4.26c-7.36-.49-20.09-.55-27.7 2-5.05 1.83-7.3 7.49-5.84 13 1.22 4.57 10.9 12.66 14.55 15.65 1.64 1.35 3.3 2.67 5 4C587.86 231.81 593.56 236.34 598.23 242.15z" fill-rule="evenodd"/></svg></a>&nbsp;
<a class=menuSocialButton href=/rss title=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="-143 145 525 525"><path d="M113 145c-141.4.0-256 114.6-256 256s114.6 256 256 256 256-114.6 256-256S254.4 145 113 145zM43.1 518.7c-6.2 6.2-14.7 9.9-24.1 9.9-9.4.0-17.8-3.8-24-9.9-6.2-6.2-10-14.6-10-23.9.0-9.4 3.8-17.8 10-24s14.6-10 24-10 17.9 3.8 24 10c6.2 6.2 10 14.6 10 24C53 504.2 49.2 512.6 43.1 518.7zM104.8 529c-.1-32.1-12.5-62.3-35.1-84.9-22.6-22.6-52.8-35.2-84.7-35.2V360c46.6.0 88.7 19 119.3 49.6s49.5 72.8 49.6 119.4H104.8zm87.2.0c-.1-114.2-92.8-207.1-206.9-207.1V273c70.6.0 134.5 28.7 180.8 75.1 46.3 46.4 75 110.3 75.1 180.9H192z"/></svg></a></footer><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class="book-page book-page-page"><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>BIP47, или гадкий утенок</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#проблема-повторного-использования-адресов>Проблема повторного использования адресов</a></li><li><a href=#принципы-работы-bip47-и-paynym>Принципы работы BIP47 и PayNym</a></li><li><a href=#руководство-использование-paynym>Руководство: использование PayNym</a><ul><li><a href=#создание-транзакции-bip47-с-помощью-samourai-wallet>Создание транзакции BIP47 с помощью Samourai Wallet</a></li><li><a href=#создание-транзакции-bip47-с-помощью-sparrow-wallet>Создание транзакции BIP47 с помощью Sparrow Wallet</a></li></ul></li><li><a href=#как-работает-bip47>Как работает BIP47</a><ul><li><a href=#многоразовый-платежный-код>Многоразовый платежный код</a></li><li><a href=#криптографический-протокол-обмен-ключами-диффи-хеллмана-на-эллиптических-кривых-ecdh>Криптографический протокол: обмен ключами Диффи-Хеллмана на эллиптических кривых (ECDH)</a></li><li><a href=#транзакция-уведомления>Транзакция уведомления</a></li><li><a href=#построение-транзакции-уведомления>Построение транзакции уведомления</a></li><li><a href=#получение-транзакции-уведомления>Получение транзакции уведомления</a></li><li><a href=#платежная-транзакция-в-рамках-bip47>Платежная транзакция в рамках BIP47</a></li><li><a href=#получение-платежа-bip47-и-выведение-приватного-ключа>Получение платежа BIP47 и выведение приватного ключа</a></li><li><a href=#возврат-платежа-bip47>Возврат платежа BIP47</a></li></ul></li><li><a href=#производное-применение-paynym>Производное применение PayNym</a></li><li><a href=#мое-личное-мнение-о-bip47>Мое личное мнение о BIP47</a><ul><li><a href=#внешние-источники-и-благодарности>Внешние источники и благодарности</a></li></ul></li></ul></li></ul></nav></aside></header><div class=pageCover><picture><img src=/img/bip47-ili-gadkij-utenok/ugly-987.webp alt=Cover></picture></div><h1>BIP47, или гадкий утенок</h1><div class=pageDate>16 сентября 2022 г.</div><article class=markdown><p>Из этой статьи вы узнаете о принципе работы протоколов BIP47 и PayNym, механизмах работы этих протоколов и практических приложениях, которые из них вытекают.</p><blockquote class="book-hint btc"><p>Перевод <a href=https://www.pandul.fr/post/bip47-paynym-et-code-de-paiement-r%C3%A9utilisable>статьи</a> <a href=https://twitter.com/Loic_Pandul>Лоика Мореля</a></p><p><a href=/contribute/>Поддержать проект</a></p></blockquote><blockquote><p>— Он больно велик! — говорили все, а индейский петух, который родился со шпорами на ногах и потому воображал себя императором, надулся и, словно корабль на всех парусах, подлетел к утенку, поглядел на него и пресердито залопотал; гребешок у него так весь и налился кровью. Бедный утенок просто не знал, что ему делать, как быть. И надо же ему было уродиться таким безобразным, каким-то посмешищем для всего птичьего двора!</p></blockquote><p>Одним из наиболее серьезных бедствий протокола Биткоин является повторное использование адресов. Прозрачность и распределенность сети делает эту практику опасной для конфиденциальности пользователей. Чтобы избежать связанных с этим проблем, рекомендуется использовать новый пустой адрес получения для каждого нового платежа, поступающего на кошелек, что в некоторых случаях может быть затруднительно.</p><p>Этот недостаток так же стар, как и &ldquo;<a href=/whitepaper>Белая книга</a>&rdquo;. Сатоши уже предостерегал нас от этого риска в своей книге, опубликованной в конце 2008 года:</p><blockquote><p>В качестве дополнительной защиты следует использовать новую пару ключей для каждой транзакции, чтобы они не были связаны с общим владельцем.</p></blockquote><p>Существует множество решений, позволяющих получать многократные платежи, не прибегая при этом к повторному использованию адреса. Каждое из них имеет свои компромиссы и недостатки. Среди всех этих решений можно выделить <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>BIP47</a> - предложение для генерации многократно используемых платежных кодов, разработанное Юстусом Ранвье и опубликованное в 2015 году. Их цель - обеспечить возможность проведения нескольких транзакций в пользу одного и того же лица без повторного использования адреса.</p><p>Первоначально это предложение было встречено частью сообщества пренебрежительно и так и не было добавлено в Bitcoin Core. Однако некоторые разработчики все же решили реализовать его. Так, кошелек <a href=https://samouraiwallet.com>Samourai Wallet</a> разработал собственную реализацию BIP47: <a href=https://samouraiwallet.com/paynym>PayNym</a>. Сегодня эта реализация доступна не только в Samourai Wallet для смартфонов, но и в <a href=https://sparrowwallet.com>Sparrow Wallet</a> для ПК.</p><p>Со временем Samourai разработал новые функции, непосредственно связанные с PayNym. Теперь на базе PayNym и BIP47 существует целая экосистема инструментов для оптимизации конфиденциальности пользователей.</p><p>Из этой статьи вы узнаете о принципе работы протоколов BIP47 и PayNym, механизмах работы этих протоколов и практических приложениях, которые из них вытекают. Я расскажу только о первой версии BIP47, той, которая сейчас используется для PayNym, но версии 2, 3 и 4 работают практически идентично.</p><blockquote class="book-hint info">Единственное существенное отличие заключается в транзакции уведомления. В версии 1 для уведомления используется простой адрес с OP_RETURN, в версии 2 - multisig скрипт (bloom-multisig) с OP_RETURN, а в версиях 3 и 4 - просто multisig скрипт (cfilter-multisig). Таким образом, упомянутые в данной статье механизмы и, в частности, рассмотренные криптографические методы, применимы ко всем четырем версиям. На сегодняшний день в реализации PayNym в кошельках Samourai и Sparrow используется первая версия BIP47.</blockquote><h2 id=проблема-повторного-использования-адресов>Проблема повторного использования адресов
<a class=anchor href=#%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d0%b0-%d0%bf%d0%be%d0%b2%d1%82%d0%be%d1%80%d0%bd%d0%be%d0%b3%d0%be-%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8f-%d0%b0%d0%b4%d1%80%d0%b5%d1%81%d0%be%d0%b2>#</a></h2><p>Адрес приема используется для получения биткоинов. Он генерируется на основе публичного ключа путем его хеширования и применения к нему определенного формата. Он может быть использован для создания нового условия расходования монеты с целью смены ее владельца.</p><p>Более того, вы наверняка уже слышали от осведомленного биткоинера, что адреса приема предназначены для одноразового использования, то есть для каждого нового платежа, поступающего в ваш портфель, необходимо генерировать новый. Хорошо, но зачем?</p><p>В принципе, повторное использование адресов не несет прямой угрозы вашим средствам. Использование криптографии на эллиптических кривых позволяет доказать сети, что вы владеете приватным ключом, не раскрывая сам ключ. Таким образом, вы можете заблокировать несколько разных UTXO на одном и том же адресе и потратить их в разное время. Если вы не раскроете приватный ключ, связанный с этим адресом, никто не сможет получить доступ к вашим средствам. Проблема повторного использования адресов - это скорее проблема конфиденциальности.</p><p>Как уже говорилось во введении, прозрачность и распределенность сети Биткоин означает, что любой пользователь, при условии наличия у него доступа к Биткоин-узлу, может наблюдать за транзакциями платежной системы. В результате он может видеть балансы различных адресов. Сатоши Накамото упомянул о возможности генерировать новые пары ключей, а значит, и новые адреса, для каждого нового платежа, поступающего в кошелек. Цель заключается в том, чтобы иметь дополнительный барьер на случай выявления связи между личностью пользователя и одной из его пар ключей.</p><p>Сегодня, с появлением компаний, занимающихся анализом блокчейна, и развитием <a href=/no-kyc>KYC</a>, использование пустых адресов - это уже не дополнительный барьер, а обязанность каждого, кто хоть немного заботится о своей конфиденциальности.</p><p>Стремление к приватности - это не излишняя забота или фантазия максималиста-биткоинера. Это конкретный параметр, напрямую влияющий на вашу личную безопасность и сохранность ваших средств. Чтобы вам было понятнее, приведем вполне конкретный пример:</p><ul><li>Боб покупает биткоин по системе <a href=/strategiya-dca>DCA</a> (Dollars Cost Average), то есть приобретает небольшое количество биткоинов через регулярные промежутки времени, чтобы сгладить цену входа. Боб систематически отправляет приобретенные средства на один и тот же адрес получения. Каждую неделю он покупает 0.01 биткоина и отправляет их на тот же адрес. Через два года Боб накопил на этом адресе целый биткоин.</li><li>Булочная за углом принимает оплату в биткоинах. Довольный Боб идет покупать свою булочку за сатоши. Для оплаты он использует заблокированные средства со своего адреса. Теперь его пекарь знает, что он владеет биткоинами. Такая крупная сумма может вызвать зависть у окружающих, а Боб потенциально может подвергнуться физическому нападению.</li></ul><p>Таким образом, повторное использование адресов позволяет наблюдателю установить неоспоримую связь между различными UTXO, а значит, иногда и между вашей личностью и всем портфелем.</p><p>Именно по этой причине большинство биткоин-кошельков автоматически генерируют новый адрес приема при нажатии на кнопку &ldquo;Получить&rdquo;. Поэтому для обычного пользователя необходимость использовать пустые адреса не является большим недостатком. С другой стороны, для онлайн-бизнеса, биржи или кампании по сбору пожертвований это ограничение может быстро стать невыполнимым.</p><p>Существует множество решений для таких организаций. Каждое из них имеет свои достоинства и недостатки, но на сегодняшний день, как мы увидим далее, BIP47 действительно отличается от других.</p><p>Проблема повторного использования адресов в Биткоине далеко не так незначительна. Как видно из приведенного ниже графика, взятого с сайта <a href=http://oxt.me/>oxt.me</a>, общий уровень повторного использования адресов Биткоин-пользователями в настоящее время составляет 52%:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-988.png><p><em>Источник: <a href=https://oxt.me/charts>https://oxt.me/charts</a></em></p></div><p>В основном такое повторное использование происходит на биржах, которые из соображений эффективности и удобства многократно используют один и тот же адрес. На сегодняшний день BIP47 является лучшим решением для борьбы с этим явлением на биржах. Это позволило бы снизить общий уровень повторного использования адресов, не создавая при этом особых трудностей для этих организаций.</p><p>Этот общий показатель для всей сети в данном случае является особенно уместным. Повторное использование адресов является проблемой не только для того, кто занимается подобной практикой, но и для всех, кто проводит с ним транзакции. Потеря приватности в Биткоине ведет себя как вирус и распространяется от пользователя к пользователю. Если посмотреть на глобальный показатель всех транзакций в сети, то можно получить представление о масштабах этого явления.</p><h2 id=принципы-работы-bip47-и-paynym>Принципы работы BIP47 и PayNym
<a class=anchor href=#%d0%bf%d1%80%d0%b8%d0%bd%d1%86%d0%b8%d0%bf%d1%8b-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b-bip47-%d0%b8-paynym>#</a></h2><p>Цель BIP47 - предложить простой способ получения большого количества платежей, не прибегая к повторному использованию адресов. Его работа основана на использовании многоразового платежного кода.</p><p>Таким образом, несколько отправителей смогут совершить несколько платежей на один многократно используемый платежный код другого пользователя, при этом получателю не придется передавать новый пустой адрес для каждой новой транзакции.</p><p>Пользователь может свободно публиковать свой платежный код (в социальных сетях, на своем сайте&mldr;) без риска потери конфиденциальности, что не характерно для классического адреса приема или публичного ключа.</p><p>Для осуществления платежа оба пользователя должны иметь биткоин-кошелек с реализацией BIP47, например PayNym в Samourai Wallet или Sparrow Wallet. Объединение платежных кодов двух пользователей позволит установить между ними секретный канал. Чтобы правильно установить этот канал, отправитель должен будет провести транзакцию уведомления (подробнее об этом я расскажу позже).</p><p>Объединение платежных кодов двух пользователей порождает общие секреты, позволяющие генерировать большое количество уникальных адресов получения биткоина (ровно 2^32). Таким образом, в реальности платеж с помощью BIP47 отправляется не на платежный код, а на вполне классические адреса, которые сами являются производными от платежных кодов участников.</p><p>Таким образом, платежный код выступает в роли виртуального идентификатора, полученного из сида кошелька. В структуре путей деривации HD-кошелька платежный код находится на глубине 3, на уровне account.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-989.jpg></div><p>Путь деривации для BIP47 на уровне purpose имеет индекс 47&rsquo; (0x8000002F). Например, путь деривации для многоразового платежного кода будет таким:</p><pre tabindex=0><code>m/47&#39;/0&#39;/0&#39;/
</code></pre><p>Чтобы вы могли представить себе, как выглядит платежный код, вот мой:</p><pre tabindex=0><code>PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
</code></pre><p>Он также может быть закодирован в виде QR-кода для облегчения коммуникации:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-990.png></div><p>Что касается PayNym Bots, этих роботов, которых можно увидеть в Twitter, то они являются просто визуальным отображением вашего платежного кода, созданного Samourai Wallet. Они создаются с помощью хеш-функции, что делает их уникальными. Вот мой с его идентификатором:</p><p><code>+throbbingpond8B1</code></p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-991.png></div><p>Эти боты не имеют реального технического применения. Зато они облегчают взаимодействие между пользователями, создавая виртуальный визуальный образ.</p><p>Для пользователя процесс осуществления платежа по BIP47 с помощью реализации PayNym предельно прост. Допустим, Алиса хочет отправлять платежи Бобу:</p><ol><li>Боб публикует свой QR-код или непосредственно многоразовый платежный код. Их можно разместить на своем сайте, в различных социальных сетях или отправить Алисе с помощью другого средства связи.</li><li>Алиса открывает кошелек Samourai или Sparrow и сканирует или вставляет платежный код Боба.</li><li>Алиса соединяет свой PayNym с PayNym Боба (&ldquo;Follow&rdquo;). Эта операция выполняется вне блокчейна и совершенно бесплатна.</li><li>Алиса подключает свой PayNym к PayNym Боба (&ldquo;Connect&rdquo;). Эта операция выполняется в блокчейне. Алиса должна заплатить комиссию майнерам, а также фиксированную плату в размере 15000 сатоши за услугу в кошельке Samourai. Плата за услугу взимается также и в Sparrow. Этот этап называется транзакцией уведомления.</li><li>После подтверждения транзакции уведомления Алиса может создать транзакцию BIP47 на адрес Боба. Ее кошелек автоматически сгенерирует новый пустой адрес получения, приватный ключ для которого есть только у Боба.</li></ol><p>Проведение операции уведомления, т.е. подключение PayNym, является обязательным предварительным шагом для осуществления платежей BIP47. С другой стороны, после его выполнения отправитель сможет совершить множество платежей получателю (ровно 2^32), без необходимости повторного проведения транзакции уведомления.</p><p>Как вы уже заметили, существуют две различные операции, позволяющие связать два PayNym: follow и connect. Операция подключения (&ldquo;connect&rdquo;) соответствует транзакции уведомления BIP47, которая представляет собой биткоин-транзакцию с определенной информацией, передаваемой в выходе OP_RETURN. Таким образом, с ее помощью устанавливается зашифрованная связь между двумя пользователями для создания общих секретов, необходимых для генерации новых пустых адресов приема.</p><p>С другой стороны, операция соединения (&ldquo;follow&rdquo; или &ldquo;link&rdquo;) позволяет установить связь по протоколу Soroban - это шифрованный протокол связи на базе Tor, специально разработанный командой Samourai Wallet.</p><p>Подведем итоги:</p><ul><li>Соединение двух PayNym (&ldquo;follow&rdquo;) совершенно бесплатно. Это позволяет установить зашифрованную связь вне блокчейна, в частности, для использования инструментов <a href=https://docs.samourai.io/spend-tools>совместных транзакций Samourai</a> (Stowaway или StonewallX2). Эта операция специфична для PayNym. Она не описана в BIP47.</li><li>Подключение PayNym является платным. Для этого необходимо выполнить транзакцию уведомления, чтобы инициировать подключение. Ее стоимость складывается из комиссии кошелька, комиссии майнерам и 546 сатоши, отправленных на адрес уведомления получателя, чтобы сообщить ему об открытии канала. Эта операция связана с BIP47. После этого отправитель может произвести множество BIP47-платежей получателю.</li></ul><p>Чтобы два кошелька могли взаимодействовать с помощью PayNym, каждый из них должен быть соединен с другим.</p><h2 id=руководство-использование-paynym>Руководство: использование PayNym
<a class=anchor href=#%d1%80%d1%83%d0%ba%d0%be%d0%b2%d0%be%d0%b4%d1%81%d1%82%d0%b2%d0%be-%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-paynym>#</a></h2><p>Теперь, когда мы рассмотрели теорию, давайте вместе изучим практику. Идея приведенных ниже уроков заключается в том, чтобы связать мой PayNym в кошельке Sparrow с моим PayNym в кошельке Samourai. В первом уроке показано, как провести транзакцию с использованием многоразового платежного кода из Samourai в Sparrow, а во втором уроке описан тот же механизм из Sparrow в Samourai.</p><p>Я сделал эти уроки в Testnet. Это не настоящие биткоины.</p><h3 id=создание-транзакции-bip47-с-помощью-samourai-wallet>Создание транзакции BIP47 с помощью Samourai Wallet
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d0%b8-bip47-%d1%81-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d1%8c%d1%8e-samourai-wallet>#</a></h3><p>Для начала вам, очевидно, понадобится приложение Samourai Wallet. Загрузить его можно непосредственно из Google Play Store или скачать <a href=https://samouraiwallet.com/download>APK-файл</a>, доступный на официальном сайте <a href=https://samouraiwallet.com>Samourai</a>.</p><p>После инициализации кошелька, если вы еще не сделали этого, запросите свой PayNym, нажав на плюс (+) в правом нижнем углу, а затем на &ldquo;PayNym&rdquo;.</p><p>Первым шагом к осуществлению платежа BIP47 будет получение многоразового платежного кода нашего получателя. Затем мы сможем соединиться с ним (”Follow”) и выполнить подключение (”Connect”):</p><center><video src=/img/bip47-ili-gadkij-utenok/ugly-992.mp4 controls style=width:100%></video></center><p>После подтверждения транзакции уведомления я могу отправлять платежи своему получателю. Каждая транзакция будет проводиться автоматически с новым пустым адресом, ключи от которого есть у получателя. Последнему не нужно выполнять никаких действий, все рассчитывается на моей стороне.</p><p>Вот как совершить транзакцию BIP47 в Samorai Wallet:</p><center><video src=/img/bip47-ili-gadkij-utenok/ugly-993.mp4 controls style=width:100%></video></center><h3 id=создание-транзакции-bip47-с-помощью-sparrow-wallet>Создание транзакции BIP47 с помощью Sparrow Wallet
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d0%b8-bip47-%d1%81-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d1%8c%d1%8e-sparrow-wallet>#</a></h3><p>Как и в случае с Samourai, вам, очевидно, потребуется программное обеспечение Sparrow. Оно доступно для ПК. <a href=https://sparrowwallet.com/download>Скачать</a> его можно с их <a href=https://sparrowwallet.com>официального сайта</a>.</p><p>Не забудьте проверить подпись разработчика и целостность загруженного программного обеспечения, прежде чем устанавливать его на свой компьютер.</p><p>Создайте кошелек и запросите свой PayNym, нажав на кнопку &ldquo;Show PayNym&rdquo; в меню &ldquo;Tools&rdquo; на верхней панели:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-994.png></div><p>Далее необходимо соединить и подключить свой PayNym к PayNym получателя. Для этого в окне &ldquo;Find Contact&rdquo; введите многоразовый платежный код получателя, нажмите &ldquo;Add Contact&rdquo;, а затем совершите транзакцию уведомления, нажав на кнопку &ldquo;Link Contact&rdquo;:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-995.webp></div><p>После подтверждения транзакции уведомления можно отправлять платежи на многоразовый платежный код. Вот как это сделать:</p><center><video src=/img/bip47-ili-gadkij-utenok/ugly-996.mp4 controls style=width:100%></video></center><p>Теперь, когда мы смогли изучить практические аспекты реализации BIP47 в PayNym, давайте рассмотрим, как работают все эти механизмы и какие криптографические методы при этом используются.</p><h2 id=как-работает-bip47>Как работает BIP47
<a class=anchor href=#%d0%ba%d0%b0%d0%ba-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%b0%d0%b5%d1%82-bip47>#</a></h2><blockquote class="book-hint info"><em>Для изучения механизмов работы BIP47 необходимо понимать структуру иерархического детерминированного кошелька (HD), механизмы получения дочерних пар ключей, а также принципы криптографии на эллиптических кривых.</em></blockquote><h3 id=многоразовый-платежный-код>Многоразовый платежный код
<a class=anchor href=#%d0%bc%d0%bd%d0%be%d0%b3%d0%be%d1%80%d0%b0%d0%b7%d0%be%d0%b2%d1%8b%d0%b9-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d1%8b%d0%b9-%d0%ba%d0%be%d0%b4>#</a></h3><p>Как объясняется во <a href=/bip47-ili-gadkij-utenok/#%d0%bf%d1%80%d0%b8%d0%bd%d1%86%d0%b8%d0%bf%d1%8b-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b-bip47-%d0%b8-paynym>второй части</a> данной работы, многоразовый платежный код располагается на глубине 3 в HD-кошельке. В итоге его можно сравнить с xpub, как по размещению и структуре, так и по его роли.</p><p>Части, составляющие 80-байтовый платежный код:</p><ul><li><span style=color:#26bb00>Байт 0:</span> Версия. Если мы используем первую версию BIP47, то этот байт будет равен 0x01.</li><li><span style=color:#83a8f0>Байт 1:</span> Битовое поле. Это место зарезервировано для указания дополнительных признаков в случае специфического использования. При простом использовании PayNym этот байт будет равен 0x00.</li><li><span style=color:#795900>Байт 2:</span> Четность <em>y</em>. Этот байт принимает значение 0x02 или 0x03 в зависимости от четности (четное число или нечетное) значения ординаты нашего публичного ключа.</li><li><span style=color:#155de9>С 3 байта по 34:</span> Значение <em>x</em>. Эти байты указывают на абсциссу нашего публичного ключа. Конкатенация <em>x</em> и четности <em>y</em> дает наш сжатый публичный ключ.</li><li><span style=color:#ff0101>С 35 байта по 66:</span> Код цепочки (chain code). Это место отведено под код цепочки, связанный с вышеупомянутым публичным ключом.</li><li>С 67 байта по 79: Это пространство зарезервировано для возможных будущих разработок. В версии 1 мы просто ставим нули, чтобы заполнить 80 байт - размер данных в выводе OP_RETURN.</li></ul><p>Вот шестнадцатеричное представление моего многоразового платежного кода, показанного в предыдущем разделе, с цветами, соответствующими представленным выше байтам:</p><p>0x<span style=color:#26bb00>01</span><span style=color:#83a8f0>00</span><span style=color:#795900>02</span><span style=color:#155de9>a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c</span><span style=color:#ff0101>3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a</span>00000000000000000000000000</p><p>Далее необходимо добавить байт префикса &ldquo;P&rdquo;, чтобы с первого взгляда определить, что вы имеете дело с платежным кодом. Этот байт имеет значение 0x47.</p><p>0x47<span style=color:#26bb00>01</span><span style=color:#83a8f0>00</span><span style=color:#795900>02</span><span style=color:#155de9>a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c</span><span style=color:#ff0101>3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a</span>00000000000000000000000000</p><p>Наконец, мы вычисляем контрольную сумму этого платежного кода с помощью двойного хеширования с использованием функции SHA256. Мы берем первые четыре байта этого хеша и конкатенируем их в конце (выделены розовым цветом).</p><p>0x47<span style=color:#26bb00>01</span><span style=color:#83a8f0>00</span><span style=color:#795900>02</span><span style=color:#155de9>a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c</span><span style=color:#ff0101>3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a</span>00000000000000000000000000<span style=color:#f0f>567080c4</span></p><p>Платежный код готов, осталось только преобразовать его в Base 58:</p><pre tabindex=0><code>PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
</code></pre><blockquote class="book-hint info">Как видно, эта конструкция очень напоминает структуру расширенного публичного ключа &ldquo;xpub&rdquo;.</blockquote><p>В процессе получения платежного кода мы использовали сжатый публичный ключ и код цепочки. Эти два элемента являются результатом детерминированной и иерархической деривации из сида кошелька по следующему пути: m/47&rsquo;/0&rsquo;/0&rsquo;/.</p><p>Для получения публичного ключа и кода цепочки многоразового платежного кода мы вычисляем главный приватный ключ из сида, затем получаем дочернюю пару с индексом 47 + 2^31 (усиленная деривация). Затем получаем две дочерние пары с индексом 2^31 (усиленная деривация).</p><h3 id=криптографический-протокол-обмен-ключами-диффи-хеллмана-на-эллиптических-кривых-ecdh>Криптографический протокол: обмен ключами Диффи-Хеллмана на эллиптических кривых (ECDH)
<a class=anchor href=#%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d0%be%d0%b3%d1%80%d0%b0%d1%84%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9-%d0%bf%d1%80%d0%be%d1%82%d0%be%d0%ba%d0%be%d0%bb-%d0%be%d0%b1%d0%bc%d0%b5%d0%bd-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0%d0%bc%d0%b8-%d0%b4%d0%b8%d1%84%d1%84%d0%b8-%d1%85%d0%b5%d0%bb%d0%bb%d0%bc%d0%b0%d0%bd%d0%b0-%d0%bd%d0%b0-%d1%8d%d0%bb%d0%bb%d0%b8%d0%bf%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d1%85-%d0%ba%d1%80%d0%b8%d0%b2%d1%8b%d1%85-ecdh>#</a></h3><p>Криптографический протокол, используемый в BIP47 называется ECDH (Elliptic-Curve Diffie-Hellman). Этот протокол является вариантом классического обмена ключами Диффи-Хеллмана.</p><p>Диффи-Хеллман в своей первой версии - это протокол обмена ключами, представленный в 1976 году, который позволяет двум людям, используя две пары (публичный и приватный) ключей, установить общий секрет путем обмена по незащищенному каналу связи.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-997.jpg></div><p>Этот общий секрет (красный ключ) может быть использован для выполнения других задач. Как правило, этот общий секрет может использоваться для шифрования и дешифрования сообщений в незащищенной сети:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-998.jpg></div><p>Для достижения такого обмена Диффи-Хеллман использует модульную арифметику для вычисления общего секрета. Вот как это работает в простых терминах:</p><ul><li>Алиса и Боб определяют общий цвет, в данном случае желтый. Этот цвет известен всем. Это открытые данные.</li><li>Алиса выбирает секретный цвет, в данном случае красный. Она смешивает два цвета, в результате чего получается оранжевый.</li><li>Боб выбирает секретный цвет, в данном случае синий. Он смешивает два цвета, в результате чего получает небесно-голубой.</li><li>Алиса и Боб могут обменяться полученными цветами: оранжевым и небесно-голубым. Этот обмен может происходить в незащищенной сети и наблюдаться злоумышленниками.</li><li>Алиса смешивает полученный от Боба небесно-голубой цвет со своим секретным цветом (красным). Она получает коричневый цвет.</li><li>Боб смешивает оранжевый цвет, полученный от Алисы, со своим секретным цветом (небесно-голубым). Он получает тот же коричневый цвет.</li></ul><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-999.png></div><p>В этом примере коричневый цвет представляет собой секрет, которым поделились Алиса и Боб. Нужно понимать, что в реальности злоумышленнику невозможно отделить оранжевый и голубой цвета, чтобы найти секретные цвета Алисы или Боба.</p><p>Теперь давайте рассмотрим, как это работает на самом деле. На первый взгляд, принцип Диффи-Хеллмана кажется сложным для понимания. На самом деле, принцип его работы - почти детская игра. Прежде чем подробно рассказать о его механизмах, напомню два математических понятия, которые нам понадобятся (и которые, кстати, используются и во многих других криптографических методах).</p><ol><li>Простое число - это натуральное число, которое имеет только два делителя: 1 и само себя. Например, число 7 является простым, поскольку оно может делиться только на 1 и на 7 (само на себя). С другой стороны, число 8 не является простым, поскольку оно может делиться на 1, 2, 4 и 8. Таким образом, у него не два делителя, а четыре целых положительных делителя.</li><li><a href=https://en.wikipedia.org/wiki/Modulo>&ldquo;Модуль&rdquo;</a> (также известный как &ldquo;<em>mod</em>&rdquo; или &ldquo;<em>%</em>&rdquo;) - это математическая операция над двумя целыми числами, которая возвращает остаток от евклидова деления первого числа на второе. Например, 16 <em>mod</em> 5 равно 1.</li></ol><p>Обмен ключами по протоколу Диффи-Хеллмана между Алисой и Бобом происходит следующим образом:</p><ul><li>Алиса и Боб определяют два общих числа: <strong><em>p</em></strong> и <strong><em>g</em></strong>. <strong><em>p</em></strong> - простое число. Чем больше число <strong><em>p</em></strong>, тем надежнее защита Диффи-Хеллмана. <strong><em>g</em></strong> - <a href=https://ru.wikipedia.org/wiki/%D0%9F%D0%B5%D1%80%D0%B2%D0%BE%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BE%D1%80%D0%B5%D0%BD%D1%8C_%28%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F_%D1%87%D0%B8%D1%81%D0%B5%D0%BB%29>первообразный корень</a> из <strong><em>p</em></strong>. Эти два числа могут быть переданы открытым текстом по незащищенной сети; они эквивалентны желтому цвету в приведенном выше примере. Алиса и Боб просто должны иметь одинаковые значения <strong><em>p</em></strong> и <strong><em>g</em></strong>.</li><li>После того как параметры выбраны, Алиса и Боб определяют секретное случайное число. Случайное число, полученное Алисой, называется <strong><em>a</em></strong> (эквивалентно красному цвету), а случайное число, полученное Бобом, называется <strong><em>b</em></strong> (эквивалентно синему цвету). Эти два числа должны оставаться в секрете.</li><li>Вместо того чтобы обмениваться этими числами <strong><em>a</em></strong> и <strong><em>b</em></strong>, каждая сторона вычислит <strong><em>A</em></strong> (заглавная буква) и <strong><em>B</em></strong> (заглавная буква) следующим образом:</li></ul><pre tabindex=0><code># A равно g в степени a по модулю p:
A = g^a % p 

# B равно g в степени b по модулю p:
B = g^b % p
</code></pre><ul><li>Эти числа A (эквивалент оранжевого цвета) и B (эквивалент небесно-голубого цвета) будут переданы сторонами друг другу. Обмен может происходить открытым текстом в незащищенной сети.</li><li>Алиса, которой теперь известно число <strong><em>B</em></strong>, вычислит значение <strong><em>z</em></strong>, следующим образом:</li></ul><pre tabindex=0><code># z равно B в степени a по модулю p: 
z = B^a % p
</code></pre><ul><li>Напомним, что <strong><em>B = g^b % p</em></strong>. Таким образом:</li></ul><pre tabindex=0><code>z = B^a % p
z = (g^b)^a % p

# В соответствии с правилами вычисления степеней:
(x^n)^m = x^nm

# Получаем:
z = g^ba % p
</code></pre><ul><li>Боб, который теперь знает <strong><em>A</em></strong>, также вычислит значение <strong><em>z</em></strong>, следующим образом:</li></ul><pre tabindex=0><code># z равно A в степени b по модулю p:
z = A^b % p
 
# Получаем:
z = (g^a)^b % p
z = g^ab % p
z = g^ba % p
</code></pre><p>Таким образом, Алиса и Боб находят совершенно одинаковое значение <strong><em>z</em></strong>. Это число представляет собой их общий секрет, т.е. эквивалент коричневого цвета в нашем примере. Они могут использовать этот общий секрет для шифрования сообщения между ними в незащищенной сети.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1000.jpg></div><p>Злоумышленник, владеющий <strong><em>p</em></strong>, <strong><em>g</em></strong>, <strong><em>A</em></strong> и <strong><em>B</em></strong>, не сможет вычислить <strong><em>a</em></strong>, <strong><em>b</em></strong> или <strong><em>z</em></strong>. Это было бы равносильно обращению экспоненты вспять. Такое вычисление невозможно провести иначе, чем перебирая все возможности по очереди, поскольку мы работаем с конечным полем. Это было бы похоже на <a href=https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB_%D0%94%D0%B8%D1%84%D1%84%D0%B8_%E2%80%94_%D0%A5%D0%B5%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD%D0%B0#%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B0_%D0%94%D0%B8%D1%84%D1%84%D0%B8_%E2%80%94_%D0%A5%D0%B5%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD%D0%B0_%D0%B8_%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B0_%D0%B4%D0%B8%D1%81%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BB%D0%BE%D0%B3%D0%B0%D1%80%D0%B8%D1%84%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F>вычисление дискретного логарифма</a>, т.е. обратного экспоненте в конечной циклической группе.</p><p>Таким образом, при достаточно больших значениях <strong><em>a</em></strong>, <strong><em>b</em></strong> и <strong><em>p</em></strong> метод Диффи-Хеллмана безопасен. При параметрах в 2048 бит (число из 600 десятичных цифр) проверить все возможности для <strong><em>a</em></strong> и <strong><em>b</em></strong> нереально. На сегодняшний день при числах такого размера алгоритм считается безопасным.</p><p>Именно в этом и заключается основной недостаток протокола Диффи-Хеллмана. Чтобы быть безопасным, алгоритм должен использовать большие числа. Поэтому сегодня мы предпочитаем использовать ECDH-вариант алгоритма Диффи-Хеллмана, использующий алгебраическую кривую, в данном случае <a href=https://ru.wikipedia.org/wiki/%D0%AD%D0%BB%D0%BB%D0%B8%D0%BF%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%BA%D1%80%D0%B8%D0%B2%D0%B0%D1%8F>эллиптическую</a>. Это позволит нам работать с гораздо меньшими числами при сохранении эквивалентной безопасности, а значит, сократить ресурсы, необходимые для вычислений и хранения.</p><p>Общий принцип работы алгоритма остается прежним. Однако вместо случайного числа <strong><em>a</em></strong> и числа <strong><em>A</em></strong>, вычисляемого из <strong><em>a</em></strong> с помощью модульного экспонирования, мы будем использовать пару ключей, созданных на эллиптической кривой. Вместо того чтобы опираться на дистрибутивность оператора модуля, мы будем использовать <a href=https://ru.wikipedia.org/wiki/%D0%AD%D0%BB%D0%BB%D0%B8%D0%BF%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%BA%D1%80%D0%B8%D0%B2%D0%B0%D1%8F#%D0%93%D1%80%D1%83%D0%BF%D0%BF%D0%BE%D0%B2%D0%BE%D0%B9_%D0%B7%D0%B0%D0%BA%D0%BE%D0%BD>групповой закон</a> для эллиптических кривых, а точнее, ассоциативность этого закона.</p><p>Если говорить кратко, то приватный ключ - это случайное число от 1 до n-1 (n - порядок кривой), а публичный ключ - уникальная точка на кривой, определяемая с помощью приватного ключа путем сложения и удвоения точек из порождающей точки следующим образом:</p><pre tabindex=0><code>K = k·G
</code></pre><p>Где <strong><em>K</em></strong> - публичный ключ, <strong><em>k</em></strong> - приватный ключ, а <strong><em>G</em></strong> - точка-генератор.</p><p>Одно из свойств этой пары ключей заключается в том, что очень легко определить <strong><em>K</em></strong>, зная <strong><em>k</em></strong> и <strong><em>G</em></strong>, но невозможно определить <strong><em>k</em></strong>, зная <strong><em>K</em></strong> и <strong><em>G</em></strong>. Это односторонняя функция.</p><p>Другими словами, легко вычислить публичный ключ, если известен приватный ключ, но невозможно вычислить приватный ключ, если известен публичный ключ. И снова эта безопасность основана на невозможности вычисления дискретного логарифма.</p><p>Это свойство мы будем использовать для адаптации нашего алгоритма Диффи-Хеллмана. Принцип работы ECDH заключается в следующем:</p><ul><li>Алиса и Боб совместно договариваются о криптографически защищенной эллиптической кривой и ее параметрах. Эта информация является общедоступной.</li><li>Алиса генерирует случайное число <strong><em><span style=color:#155de9>ka</span></em></strong>, которое будет ее приватным ключом. Этот приватный ключ должен оставаться в секрете. Свой публичный ключ <strong><em><span style=color:#26bb00>Ka</span></em></strong> она определяет путем сложения и удвоения точек на выбранной эллиптической кривой.</li></ul><pre tabindex=0><code>Ka = ka·G
</code></pre><ul><li>Боб также генерирует случайное число, которое будет его приватным ключом <strong><em><span style=color:#155de9>kb</span></em></strong>. И вычисляет связанный с ним публичный ключ <strong><em><span style=color:#26bb00>Kb</span></em></strong>.</li></ul><pre tabindex=0><code>Kb = kb·G
</code></pre><ul><li>Алиса и Боб обмениваются своими публичными ключами <strong><em><span style=color:#26bb00>Ka</span></em></strong> и <strong><em><span style=color:#26bb00>Kb</span></em></strong> в незащищенной сети общего пользования.</li><li>Алиса вычисляет точку (<strong><em><span style=color:#f8941c>x</span></em></strong>,<strong><em><span style=color:#f8941c>y</span></em></strong>) на кривой, применяя свой приватный ключ <strong><em><span style=color:#155de9>ka</span></em></strong> к публичному ключу Боба <strong><em><span style=color:#26bb00>Kb</span></em></strong>.</li></ul><pre tabindex=0><code>(x,y) = ka·Kb
</code></pre><ul><li>Боб вычисляет точку (<strong><em><span style=color:#f8941c>x</span></em></strong>,<strong><em><span style=color:#f8941c>y</span></em></strong>) на кривой, применяя свой приватный ключ <strong><em><span style=color:#155de9>kb</span></em></strong> к публичному ключу Алисы <strong><em><span style=color:#26bb00>Ka</span></em></strong>.</li></ul><pre tabindex=0><code>(x,y) = kb·Ka
</code></pre><ul><li>Алиса и Боб получают одну и ту же точку на эллиптической кривой. Общий секрет будет представлять собой координату <strong><em><span style=color:#f8941c>x</span></em></strong> этой точки.</li></ul><p>Они получают один и тот же общий секрет, потому что:</p><pre tabindex=0><code>(x,y) = ka·Kb = ka·kb·G = kb·ka·G = kb·Ka
</code></pre><p>Злоумышленник, наблюдающий за незащищенной общедоступной сетью, сможет получить только публичные ключи сторон и параметры выбранной кривой. Как было сказано выше, эти две части информации сами по себе не могут быть использованы для определения приватных ключей, поэтому злоумышленник не сможет получить доступ к секрету.</p><p>Таким образом, ECDH является алгоритмом обмена ключами. Он часто используется наряду с другими криптографическими методами для определения протокола. Например, ECDH лежит в основе TLS (Transport Layer Security) - протокола шифрования и аутентификации, используемого на транспортном уровне Интернета. В TLS для обмена ключами используется ECDHE - вариант ECDH, в котором ключи являются эфемерными, чтобы обеспечить постоянную конфиденциальность. Помимо ECDH, в TLS также используются алгоритм аутентификации ECDSA, алгоритм шифрования AES и хеш-функция SHA256.</p><p>В частности, TLS определяет букву &ldquo;s&rdquo; в слове &ldquo;https&rdquo;, а также маленький замочек, который вы видите на экране браузера в левом верхнем углу, гарантирующий, что обмен данными зашифрован. Таким образом, читая эту статью, вы используете ECDH, и, возможно, вы используете его каждый день, даже не подозревая об этом.</p><h3 id=транзакция-уведомления>Транзакция уведомления
<a class=anchor href=#%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d1%8f-%d1%83%d0%b2%d0%b5%d0%b4%d0%be%d0%bc%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f>#</a></h3><p>Как мы выяснили в предыдущем разделе, ECDH - это вариант протокола Диффи-Хеллмана с использованием пар ключей, созданных на эллиптической кривой. И хорошо, что в наших кошельках Bitcoin есть множество пар ключей, соответствующих этому стандарту!</p><p>Идея заключается в том, чтобы использовать пары ключей иерархических детерминированных кошельков Bitcoin двух участвующих сторон для создания общих и эфемерных секретов между ними. В BIP47 вместо этого используется ECDHE (Elliptic Curve Diffie-Hellman Ephemeral).</p><p>ECDHE используется в BIP47 для передачи платежного кода от отправителя к получателю. Это и есть транзакция уведомления. Фактически для использования BIP47 каждая из двух сторон (отправитель, отправляющий платежи, и получатель, получающий платежи) должна знать платежный код другой стороны. Это необходимо для получения эфемерных публичных ключей, а значит, и выделенных адресов получения.</p><p>До обмена платежными кодами отправитель уже знает платежный код получателя, поскольку он мог найти его вне блокчейна, например, на сайте получателя или в социальных сетях. Однако получатель не обязательно знает платежный код отправителя. Его необходимо сообщить, иначе получатель не сможет получить свои эфемерные ключи, а значит, не сможет узнать, где находятся его биткоины, и потратить свои средства. Мы могли бы отправить платежный код вне блокчейна, используя другую систему связи, но это создаст проблему, если кошелек будет восстановлен из сида.</p><p>Это связано с тем, что, как я уже отмечал, адреса BIP47 получаются не из сида получателя (иначе можно было бы использовать один из xpub напрямую), а в результате вычисления двух платежных кодов: получателя и отправителя. Именно поэтому, если получатель потеряет свой кошелек и попытается восстановить его по своему сиду, ему обязательно понадобятся все платежные коды тех, кто отправил ему биткоины через BIP47.</p><p>Можно было бы легко использовать BIP47 без этой уведомительной транзакции, но при этом каждый пользователь должен был бы создавать резервные копии платежных кодов своих контрагентов. Эта ситуация будет оставаться таковой до тех пор, пока мы не найдем простой и надежный способ создания, хранения и обновления таких резервных копий. Поэтому в настоящее время транзакция уведомления является практически обязательной.</p><p>Как следует из названия, эта операция не только передает платежный код, но и выполняет функцию оповещения получателя. Она уведомляет получателя о том, что платежный канал только что был открыт.</p><p>Прежде чем более подробно рассказать о технической стороне транзакции уведомления, я хотел бы немного остановиться на модели конфиденциальности. Модель BIP47 предусматривает некоторые меры предосторожности, принятые при построении этой начальной транзакции.</p><p>Сам по себе платежный код не представляет непосредственного риска потери конфиденциальности. В отличие от классической модели Bitcoin, в которой связь между личностью пользователя и транзакциями разрывается, в частности, за счет анонимности публичных ключей, платежный код может быть напрямую связан с личностью. Очевидно, что это не является обязательным условием, но такая связь не представляет опасности.</p><p>Это связано с тем, что платежный код не является непосредственным источником адресов, используемых для получения платежей BIP47. Вместо этого адреса получаются путем применения ECDHE между дочерними ключами платежных кодов двух сторон.</p><p>Таким образом, сам по себе платежный код не представляет прямого риска потери конфиденциальности, поскольку из него может быть получен только адрес для уведомления. Из него можно получить некоторую информацию, но узнать, с кем вы совершаете сделку, обычно не представляется возможным.</p><p>Поэтому очень важно поддерживать строгое разделение между платежными кодами пользователей. При этом первоначальное сообщение кода является критическим моментом для обеспечения конфиденциальности платежа, и в то же время оно необходимо для корректной работы протокола. Если один из двух платежных кодов может быть получен публично (например, с веб-сайта), то второй код, т.е. код отправителя, не должен быть связан с первым.</p><p>Допустим, я хочу сделать пожертвование с помощью BIP47 на мирное протестное движение дальнобойщиков в Канаде:</p><ul><li>Эта организация опубликовала свой платежный код непосредственно на своем сайте или в социальных сетях.</li><li>Таким образом, этот код ассоциируется с протестным движением.</li><li>Я так же имею публичный платежный код.</li><li>Прежде чем отправить им транзакцию, я должен убедиться, что они знают мой персональный платежный код, который также связан с моей личностью, поскольку я использую его для получения транзакций в своих социальных сетях.</li></ul><p>Как я могу отправить его им? Если я отправлю его им с помощью обычных средств связи, есть риск, что информация просочится, и меня запишут в сторонники протестного движения.</p><p>Конечно, транзакция с уведомлением не является единственным решением для скрытой передачи платежного кода отправителя, но на данный момент она прекрасно справляется с этой ролью, применяя несколько уровней защиты.</p><p>На приведенной ниже диаграмме красные линии обозначают момент, когда информационный поток должен быть прерван, а черные стрелки - неоспоримые связи, которые может установить сторонний наблюдатель:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1001.jpg></div><p>В действительности для классической модели конфиденциальности Bitcoin зачастую сложно полностью прервать информационный поток между ключевой парой и пользователем, особенно при удаленном совершении транзакций. Например, в случае кампании по сбору пожертвований получатель будет вынужден раскрыть публичный адрес или публичный ключ на своем сайте или в социальных сетях. Использование BIP47 с транзакцией уведомления решает эту проблему благодаря ECDHE и слою шифрования, который мы будем изучать.</p><p>Очевидно, что классическая модель конфиденциальности Bitcoin по-прежнему соблюдается на уровне эфемерных публичных ключей, получаемых в результате комбинации двух платежных кодов. Эти две модели взаимозависимы. Я просто хочу подчеркнуть, что, в отличие от классического использования публичного ключа для получения биткоинов, платежный код может быть связан с личностью, поскольку информация &ldquo;Боб совершает транзакцию с Алисой&rdquo; нарушается в другое время. Платежный код используется для генерации платежных адресов, но, наблюдая только за блокчейном, невозможно связать платежную транзакцию BIP47 с платежными кодами, которые использовались для ее проведения.</p><h3 id=построение-транзакции-уведомления>Построение транзакции уведомления
<a class=anchor href=#%d0%bf%d0%be%d1%81%d1%82%d1%80%d0%be%d0%b5%d0%bd%d0%b8%d0%b5-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d0%b8-%d1%83%d0%b2%d0%b5%d0%b4%d0%be%d0%bc%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f>#</a></h3><p>Теперь посмотрим, как работает эта транзакция уведомления. Представим, что Алиса хочет отправить деньги Бобу, используя BIP47. В моем примере Алиса выступает в роли отправителя, а Боб - в роли получателя. Боб опубликовал свой платежный код на своем сайте. Поэтому Алиса уже знает платежный код Боба.</p><ol><li>Алиса вычисляет общий секрет с помощью ECDH:</li></ol><ul><li>Она выбирает из своего HD-кошелька пару ключей, которая находится на другой ветке, отличной от той, где находится ее платежный код. Обратите внимание, что эта пара не должна легко ассоциироваться ни с адресом уведомления Алисы, ни с ее личностью (см. предыдущий раздел).</li><li>Алиса берет приватный ключ из этой пары. Мы назовем его &ldquo;a&rdquo; (в нижнем регистре).</li></ul><pre tabindex=0><code>a
</code></pre><ul><li>Алиса извлекает публичный ключ, связанный с адресом уведомления Боба. Этот ключ - первый дочерний ключ, полученный из платежного кода Боба (индекс 0). Мы называем этот публичный ключ &ldquo;B&rdquo; (заглавная буква). Приватный ключ, связанный с этим публичным ключом, называется &ldquo;b&rdquo; (строчная буква). &ldquo;B&rdquo; определяется путем сложения и удвоения точек на эллиптической кривой, начиная с &ldquo;G&rdquo; (порождающей точки) и заканчивая &ldquo;b&rdquo; (приватным ключом).</li></ul><pre tabindex=0><code>B = b·G
</code></pre><ul><li>Алиса вычисляет секретную точку &ldquo;S&rdquo; (верхний регистр) на эллиптической кривой путем сложения и удвоения точек, применяя свой приватный ключ &ldquo;a&rdquo; к публичному ключу Боба &ldquo;B&rdquo;.</li></ul><pre tabindex=0><code>S = a·B
</code></pre><ul><li>Алиса вычисляет коэффициент ослепления &ldquo;f&rdquo;, который будет использоваться для шифрования ее платежного кода. Для этого она использует функцию HMAC-SHA512 для определения псевдослучайного числа. Вторым входом этой функции является значение, которое сможет найти Боб: (x), которое является абсциссой секретной точки, вычисленной ранее. Первым входом является (o) - UTXO, используемый в качестве входа в данную транзакцию.</li></ul><pre tabindex=0><code>f = HMAC-SHA512(o, x)
</code></pre><ol start=2><li><p>Алиса переводит свой личный платежный код в основание 2 (двоичное).</p></li><li><p>Она использует этот ослепляющий фактор в качестве ключа для выполнения симметричного шифрования содержимого своего платежного кода. Используемый алгоритм шифрования представляет собой простое <a href=https://ru.wikipedia.org/wiki/%D0%98%D1%81%D0%BA%D0%BB%D1%8E%D1%87%D0%B0%D1%8E%D1%89%D0%B5%D0%B5_%C2%AB%D0%B8%D0%BB%D0%B8%C2%BB>XOR</a>. Выполняемая операция сравнима с <a href=https://ru.wikipedia.org/wiki/%D0%A8%D0%B8%D1%84%D1%80_%D0%92%D0%B5%D1%80%D0%BD%D0%B0%D0%BC%D0%B0>шифром Вернама</a>, известным также как &ldquo;одноразовый блокнот&rdquo;:</p></li></ol><ul><li>Сначала Алиса делит свой коэффициент ослепления на две части: первые 32 байта называются &ldquo;f1&rdquo;, а последние 32 байта - &ldquo;f2&rdquo;. Получаем:</li></ul><pre tabindex=0><code>f = f1 || f2
</code></pre><ul><li>Алиса отдельно вычисляет шифротекст (x&rsquo;) публичного ключа (x) своего платежного кода и шифротекст (c&rsquo;) своего кода цепочки <em>(chain code)</em> (c). В качестве ключей шифрования выступают соответственно &ldquo;f1&rdquo; и &ldquo;f2&rdquo;. Используется операция XOR (исключающее &ldquo;или&rdquo;).</li></ul><pre tabindex=0><code>x&#39; = x XOR f1
c&#39; = c XOR f2
</code></pre><ul><li>Алиса заменяет реальные значения абсциссы публичного ключа (x) и кода цепочки (c) в своем платежном коде на зашифрованные значения (x&rsquo;) и (c&rsquo;).</li></ul><p>Прежде чем продолжить техническое описание этой транзакции уведомления, рассмотрим операцию XOR. XOR - это побитовый логический оператор, основанный на булевой алгебре. При задании двух операндов в битах он возвращает 1, если биты одинакового ранга различны, и 0, если биты одинакового ранга равны. Приведем таблицу истинности XOR в зависимости от значений операндов D и E:</p><table><thead><tr><th>D</th><th>E</th><th>D <em>XOR</em> E</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>1</td></tr><tr><td>1</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr></tbody></table><p>Например:</p><pre tabindex=0><code>0110 XOR 1110 = 1000
</code></pre><p>Или:</p><pre tabindex=0><code>010011 XOR 110110 = 100101
</code></pre><p>В ECDH использование XOR в качестве уровня шифрования особенно органично. Во-первых, благодаря этому оператору шифрование является симметричным. Это означает, что получатель может расшифровать код платежа с помощью того же ключа, который использовался для шифрования. Ключи шифрования и дешифрования вычисляются из общего секрета с помощью ECDH.</p><p>Такая симметрия возможна благодаря свойствам коммутативности и ассоциативности оператора XOR:</p><pre tabindex=0><code> # Прочие свойства:
 -&gt; D ⊕ D = 0
 -&gt; D ⊕ 0 = D
 
 # Коммутативность:
 D ⊕ E = E ⊕ D
 
 # Ассоциативность:
 D ⊕ (E ⊕ Z) = (D ⊕ E) ⊕ Z = D ⊕ E ⊕ Z
 
 # Симметричность:
 Если: D ⊕ E = L
 То:   D ⊕ L = D ⊕ (D ⊕ E) = D ⊕ D ⊕ E = 0 ⊕ E = E
 -&gt;  D ⊕ L = E
</code></pre><p>Во-вторых, этот метод шифрования очень похож на <a href=https://ru.wikipedia.org/wiki/%D0%A8%D0%B8%D1%84%D1%80_%D0%92%D0%B5%D1%80%D0%BD%D0%B0%D0%BC%D0%B0>шифр Вернама</a> (одноразовый блокнот) - единственный известный на сегодняшний день алгоритм шифрования, обладающий безусловной (или абсолютной) безопасностью. Для того чтобы шифр Вернама обладал такими свойствами, ключ шифрования должен быть совершенно случайным, иметь размер, равный размеру сообщения, и использоваться только один раз. В используемом здесь методе шифрования BIP47 ключ имеет размер, равный размеру сообщения, а коэффициент ослепления равен конкатенации абсциссы публичного ключа с &ldquo;chain code&rdquo; платежного кода. Такой ключ шифрования используется только один раз. Однако этот ключ не является производным от совершенной случайности, поскольку он представляет собой HMAC. Вместо этого он является псевдослучайным. Таким образом, это не шифр Вернама, но метод близок к нему.</p><p>Вернемся к построению транзакции уведомления:</p><ol start=4><li>Таким образом, Алиса в настоящее время имеет свой платежный код с зашифрованной полезной нагрузкой. Она собирается построить и передать транзакцию, в которой на входе будет ее публичный ключ &ldquo;A&rdquo;, на выходе - адрес уведомления Боба, а в выходе OP_RETURN - ее платежный код с зашифрованной полезной нагрузкой. Эта транзакция является транзакцией уведомления.</li></ol><p>OP_RETURN - это &ldquo;opcode&rdquo;, т.е. скрипт, который помечает вывод транзакции Bitcoin как нерасходуемый. Сегодня он используется для трансляции и закрепления информации в блокчейне Bitcoin. В нем может храниться до 80 байт данных, которые затем записываются в блокчейн и становятся видны всем остальным пользователям.</p><p>Как мы видели в <a href=/bip47-ili-gadkij-utenok/#%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d0%be%d0%b3%d1%80%d0%b0%d1%84%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9-%d0%bf%d1%80%d0%be%d1%82%d0%be%d0%ba%d0%be%d0%bb-%d0%be%d0%b1%d0%bc%d0%b5%d0%bd-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0%d0%bc%d0%b8-%d0%b4%d0%b8%d1%84%d1%84%d0%b8-%d1%85%d0%b5%d0%bb%d0%bb%d0%bc%d0%b0%d0%bd%d0%b0-%d0%bd%d0%b0-%d1%8d%d0%bb%d0%bb%d0%b8%d0%bf%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d1%85-%d0%ba%d1%80%d0%b8%d0%b2%d1%8b%d1%85-ecdh>предыдущем разделе</a>, алгоритм Диффи-Хеллмана используется для создания секрета, который передается двум пользователям, общающимся по незащищенной сети и потенциально наблюдаемым злоумышленниками. В BIP47 ECDH используется для связи в сети Bitcoin, которая по своей природе является прозрачной сетью, наблюдаемой многими злоумышленниками. Общий секрет, вычисленный с помощью обмена ключами Диффи-Хеллмана на эллиптической кривой, затем используется для шифрования передаваемой секретной информации: платежного кода отправителя (Алисы).</p><p>Приведем схему из BIP47, которая иллюстрирует то, что мы только что описали:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1002.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Если сопоставить эту схему с тем, что я описал ранее, то:</p><ul><li>&ldquo;Wallet Priv-Key&rdquo; на стороне Алисы соответствует: <strong><em>a</em></strong>.</li><li>&ldquo;Child Pub-Key 0&rdquo; на стороне Боба соответствует: <strong><em>B</em></strong>.</li><li>&ldquo;Notification Shared Secret&rdquo; соответствует: <strong><em>f</em></strong>.</li><li>&ldquo;Masked Payment Code&rdquo; соответствует замаскированному платежному коду, т.е. с зашифрованной полезной нагрузкой: <strong><em>x&rsquo;</em></strong> и <strong><em>c&rsquo;</em></strong>.</li><li>&ldquo;Notification Transaction&rdquo; - это транзакция, содержащая OP_RETURN.</li></ul><p>Я обобщу только что рассмотренные нами шаги по проведению транзакции уведомления:</p><ul><li>Алиса получает платежный код и адрес уведомления Боба.</li><li>Алиса выбирает из своего HD-кошелька принадлежащий ей UTXO с соответствующей парой ключей.</li><li>Она вычисляет секретную точку на эллиптической кривой с помощью ECDH.</li><li>Она использует эту секретную точку для вычисления HMAC, который является коэффициентом ослепления.</li><li>Она использует этот ослепляющий фактор для шифрования полезной нагрузки своего персонального платежного кода.</li><li>Для передачи замаскированного платежного кода Бобу используется выход OP_RETURN в транзакции уведомления.</li></ul><p>Для того чтобы более подробно понять, как это работает, и в частности, как используется OP_RETURN, рассмотрим реальную транзакцию уведомления. Подобную транзакцию я проводил в Testnet, с которой можно ознакомиться по <a href=https://mempool.space/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e>ссылке</a>.</p><p>TXID:</p><pre tabindex=0><code>0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e
</code></pre><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1003.png><p><em>Источник: <a href=https://blockstream.info/>https://blockstream.info/</a></em></p></div><p>Рассматривая эту транзакцию, мы видим, что она имеет один вход и 4 выхода:</p><ul><li>Первый выход - OP_RETURN, который содержит мой скрытый платежный код.</li><li>Второй выход на 546 сатоши указывает на адрес уведомления моего получателя.</li><li>Третий вывод в размере 15 000 сат представляет собой комиссию, поскольку для проведения этой транзакции я использовал кошелек Samourai Wallet.</li><li>Четвертый выход на два миллиона сатоши представляет собой сдачу, т.е. оставшуюся разницу из моего входа, которая возвращается на другой принадлежащий мне адрес.</li></ul><p>Наиболее интересным для изучения, очевидно, является выход 0 с OP_RETURN. Рассмотрим подробнее, что он содержит:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1004.png><p><em>Источник: <a href=https://blockstream.info/>https://blockstream.info/</a></em></p></div><p>Выходной скрипт в шестнадцатеричном виде:</p><pre tabindex=0><code>6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
</code></pre><p>Этот скрипт состоит из нескольких частей:</p><p>6a4c50<span style=color:#26bb00>010002</span><span style=color:#155de9>b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164</span><span style=color:#ff0101>927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8</span>00000000000000000000000000</p><ul><li><p>Опкоды: 6a4c</p></li><li><p>Байт, указывающий размер сообщения (80 байт): 50</p></li><li><p>Метаданные моего незашифрованного платежного кода: <span style=color:#26bb00>010002</span></p></li><li><p>Зашифрованная абсцисса публичного ключа моего платежного кода: <span style=color:#155de9>b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164</span></p></li><li><p>Зашифрованный код цепочки (chain code) моего платежного кода: <span style=color:#ff0101>927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8</span></p></li><li><p>Дополнение для достижения 80 байт: 00000000000000000000000000</p></li></ul><p>Опкоды включают 0x6a для OP_RETURN и 0x4c для OP_PUSHDATA1. Байт, следующий за этим последним опкодом, указывает на размер последующей полезной нагрузки. Он указывает на 0x50, т.е. 80 байт.</p><p>Далее следует платежный код с зашифрованной полезной нагрузкой.</p><p>Вот мой незашифрованный платежный код, использованный в этой операции:</p><ul><li>В base 58: PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU</li><li>В base 16 (HEX): <span style=color:#795900>47</span><span style=color:#26bb00>010002</span><span style=color:#155de9>77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a</span><span style=color:#ff0101>dd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc</span>00000000000000000000000000<span style=color:#f0f>8604e4db</span></li></ul><p>Если сравнить мой незашифрованный код платежа с OP_RETURN, то видно, что HRP (коричневый цвет) и контрольная сумма (розовый цвет) не передаются. Это нормально, так как эта информация предназначена для человека.</p><p>Далее мы можем узнать (зеленым цветом) версию (0x01), битовое поле (0x00) и четность публичного ключа (0x02). И в конце платежного кода - пустые байты черного цвета (0x00), которые дополняют количество байт до 80. Все эти метаданные передаются в незашифрованном виде.</p><p>Наконец, мы видим, что абсцисса публичного ключа (синий цвет) и код цепочки (красный цвет) зашифрованы. Это и есть полезная нагрузка платежного кода.</p><h3 id=получение-транзакции-уведомления>Получение транзакции уведомления
<a class=anchor href=#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d0%b8-%d1%83%d0%b2%d0%b5%d0%b4%d0%be%d0%bc%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f>#</a></h3><p>Теперь, когда Алиса отправила Бобу транзакцию уведомления, посмотрим, как Боб ее интерпретирует.</p><p>Напомним, что Боб должен иметь доступ к платежному коду Алисы. Без этой информации, как мы увидим в следующем разделе, он не сможет вывести ключевые пары, созданные Алисой, а значит, не сможет получить доступ к своим биткоинам, полученным с помощью BIP47. На данный момент полезная нагрузка платежного кода Алисы зашифрована. Посмотрим, как Боб его расшифрует.</p><ol><li>Боб отслеживает транзакции, создающие выходы с его адресом уведомления.</li><li>Когда транзакция имеет выход на адресе уведомления, Боб анализирует ее на предмет наличия в ней выхода OP_RETURN, соответствующего стандарту BIP47.</li><li>Если первый байт полезной нагрузки OP_RETURN равен 0x01, то Боб начинает поиск возможного секрета, совместно используемого с ECDH:</li></ol><ul><li>Боб выбирает публичный ключ из транзакции в качестве входного. Это публичный ключ Алисы с именем &ldquo;A&rdquo;:</li></ul><pre tabindex=0><code>A = a·G
</code></pre><ul><li>Боб выбирает приватный ключ &ldquo;b&rdquo;, связанный с его личным адресом уведомления:</li></ul><pre tabindex=0><code>b
</code></pre><ul><li>Боб вычисляет секретную точку &ldquo;S&rdquo; (общий секрет ECDH) на эллиптической кривой путем сложения и удвоения точек, применяя свой приватный ключ &ldquo;b&rdquo; к публичному ключу Алисы &ldquo;A&rdquo;:</li></ul><pre tabindex=0><code>S = b·A
</code></pre><ul><li>Боб определяет коэффициент ослепления &ldquo;f&rdquo;, который позволит расшифровать полезную нагрузку платежного кода Алисы. Аналогично тому, как Алиса вычислила его ранее, Боб найдет &ldquo;f&rdquo;, применив HMAC-SHA512 к (x) - значению абсциссы секретной точки &ldquo;S&rdquo;, и к (o) - UTXO, используемому в качестве входа в эту транзакцию уведомления:</li></ul><pre tabindex=0><code>f = HMAC-SHA512(o, x)
</code></pre><ol start=4><li>Боб интерпретирует данные OP_RETURN в транзакции уведомления как платежный код. Он просто расшифрует полезную нагрузку этого потенциального кода платежа, используя коэффициент ослепления &ldquo;f&rdquo;:</li></ol><ul><li>Боб разбивает коэффициент ослепления &ldquo;f&rdquo; на две части: первые 32 байта &ldquo;f&rdquo; будут &ldquo;f1&rdquo;, а последние 32 байта - &ldquo;f2&rdquo;.</li><li>Боб расшифровывает значение зашифрованной абсциссы (x&rsquo;) публичного ключа платежного кода Алисы:</li></ul><pre tabindex=0><code>x = x&#39; XOR f1
</code></pre><ul><li>Боб расшифровывает значение кода цепочки (c&rsquo;) в платежном коде Алисы:</li></ul><pre tabindex=0><code>c = c&#39; XOR f2
</code></pre><ol start=5><li>Боб проверяет, входит ли значение публичного ключа платежного кода Алисы в группу secp256k1. Если да, то он интерпретирует его как действительный платежный код. В противном случае он игнорирует транзакцию.</li></ol><p>Теперь, когда Боб знает код платежа Алисы, Алиса может послать ему до 2^32 платежей, не повторяя ни разу транзакцию уведомления.</p><p>Почему это работает? Как Бобу удается определить тот же коэффициент ослепления, что и Алисе, и, следовательно, расшифровать ее платежный код? Рассмотрим подробнее действие ECDH в описанном выше контексте.</p><p>Прежде всего, мы имеем дело с симметричным шифрованием. Это означает, что ключ шифрования и ключ дешифрования являются одним и тем же значением. Таким ключом в транзакции уведомления является коэффициент ослепления (f = f1 || f2). Поэтому Алисе и Бобу необходимо получить одно и то же значение для f, не передавая его напрямую, так как злоумышленник может украсть его и расшифровать секретную информацию.</p><p>Этот коэффициент ослепления получается путем применения HMAC-SHA512 к двум значениям: абсциссе секретной точки и UTXO, использованному в транзакции. Таким образом, Бобу необходимо иметь эти две части информации, чтобы расшифровать полезную нагрузку платежного кода Алисы.</p><p>Что касается UTXO на входе, то Боб может просто получить его, наблюдая за транзакцией уведомления. Для секретной точки Бобу придется использовать ECDH.</p><p>Как мы видели в <a href=/bip47-ili-gadkij-utenok/#%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d0%be%d0%b3%d1%80%d0%b0%d1%84%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b9-%d0%bf%d1%80%d0%be%d1%82%d0%be%d0%ba%d0%be%d0%bb-%d0%be%d0%b1%d0%bc%d0%b5%d0%bd-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0%d0%bc%d0%b8-%d0%b4%d0%b8%d1%84%d1%84%d0%b8-%d1%85%d0%b5%d0%bb%d0%bb%d0%bc%d0%b0%d0%bd%d0%b0-%d0%bd%d0%b0-%d1%8d%d0%bb%d0%bb%d0%b8%d0%bf%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d1%85-%d0%ba%d1%80%d0%b8%d0%b2%d1%8b%d1%85-ecdh>разделе</a>, посвященном Диффи-Хеллману, просто обменявшись публичными ключами и тайно применив свои приватные ключи к публичным ключам друг друга, Алиса и Боб могут найти точную секретную точку на эллиптической кривой. На этом механизме основана транзакция уведомления:</p><pre tabindex=0><code># Пара ключей Боба:
B = b·G

# Пара ключей Алисы:
A = a·G

# Для секретной точки S (x,y):
S = a·B = a·b·G = b·a·G = b·A
</code></pre><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1005.jpg></div><p>Теперь, когда Боб знает код платежа Алисы, он сможет обнаружить ее платежи BIP47 и вывести приватные ключи, блокирующие полученные биткоины.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1006.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Если сопоставить эту схему с тем, что я описал ранее, то:</p><ul><li>&ldquo;Wallet Pub-Key&rdquo; на стороне Алисы соответствует <strong><em>A</em></strong>.</li><li>&ldquo;Child Priv-Key 0&rdquo; на стороне Боба соответствует <strong><em>b</em></strong>.</li><li>&ldquo;Notification Shared Secret&rdquo; соответствует <strong><em>f</em></strong>.</li><li>&ldquo;Masked Payment Code&rdquo; соответствует замаскированному платежному коду Алисы, т.е. с зашифрованной полезной нагрузкой: <strong><em>x&rsquo;</em></strong> и <strong><em>c&rsquo;</em></strong>.</li><li>&ldquo;Notification Transaction&rdquo; - это транзакция, содержащая OP_RETURN.</li></ul><p>Я подведу итог только что рассмотренным шагам по приему и интерпретации транзакции уведомления:</p><ul><li>Боб отслеживает выходы транзакций на свой адрес уведомления.</li><li>При обнаружении такового он извлекает информацию, содержащуюся в OP_RETURN.</li><li>Боб выбирает публичный ключ в качестве входного и вычисляет секретную точку с помощью ECDH.</li><li>Он использует эту секретную точку для вычисления HMAC, который является коэффициентом ослепления.</li><li>Он использует этот фактор ослепления для расшифровки полезной нагрузки платежного кода Алисы, содержащегося в OP_RETURN.</li></ul><h3 id=платежная-транзакция-в-рамках-bip47>Платежная транзакция в рамках BIP47
<a class=anchor href=#%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d0%b0%d1%8f-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d1%8f-%d0%b2-%d1%80%d0%b0%d0%bc%d0%ba%d0%b0%d1%85-bip47>#</a></h3><p>Рассмотрим процесс оплаты с помощью BIP47. Напомним текущую ситуацию :</p><ul><li>Алиса знает платежный код Боба, который она просто взяла с его сайта.</li><li>Боб знает платежный код Алисы благодаря транзакции уведомления.</li><li>Алиса произведет свой первый платеж Бобу. Аналогичным образом она может произвести еще много платежей.</li></ul><p>Прежде чем объяснить этот процесс, считаю нужным напомнить, с какими индексами мы сейчас работаем:</p><p>Путь деривации для платежного кода описывается следующим образом: m/47&rsquo;/0&rsquo;/0&rsquo;/.</p><p>Следующая глубина делит индексы следующим образом:</p><ul><li>Первая обычная (не усиленная) дочерняя пара ключей - та, которая используется для генерации адреса уведомления, рассмотренного в предыдущем разделе: m/47&rsquo;/0&rsquo;/0&rsquo;/0/.</li><li>Для генерации адресов приема платежей BIP47 в рамках ECDH используются обычные дочерние пары ключей, как мы увидим в этом разделе: m/47&rsquo;/0&rsquo;/0&rsquo;/ от 0 до 2 147 483 647/.</li><li>Пары усиленных дочерних ключей представляют собой эфемерные платежные коды: m/47&rsquo;/0&rsquo;/0&rsquo;/ от 0&rsquo; до 2 147 483 647&rsquo;/.</li></ul><p>Каждый раз, когда Алиса хочет отправить платеж Бобу, она получает новый уникальный пустой адрес, снова используя протокол ECDH:</p><ul><li>Алиса выбирает первый приватный ключ, полученный из ее персонального многоразового платежного кода:</li></ul><pre tabindex=0><code>a
</code></pre><ul><li>Алиса выбирает первый неиспользованный публичный ключ, полученный из платежного кода Боба. Назовем этот публичный ключ &ldquo;B&rdquo;. Он связан с приватным ключом &ldquo;b&rdquo;, о котором знает только Боб.</li></ul><pre tabindex=0><code>B = b·G
</code></pre><ul><li>Алиса вычисляет секретную точку &ldquo;S&rdquo; на эллиптической кривой путем сложения и удвоения точек, применяя свой приватный ключ &ldquo;a&rdquo; к публичному ключу Боба &ldquo;B&rdquo;:</li></ul><pre tabindex=0><code>S = a·B
</code></pre><ul><li>Из этой секретной точки Алиса вычислит общий секрет &ldquo;s&rdquo; (в нижнем регистре). Для этого она выбирает абсциссу секретной точки &ldquo;S&rdquo;, обозначаемую как &ldquo;Sx&rdquo;, и передает это значение хеш-функции SHA256.</li></ul><pre tabindex=0><code>s = SHA256(Sx)
</code></pre><ul><li>Алиса использует этот общий секрет &ldquo;s&rdquo; для вычисления адреса приема платежа Bitcoin. Сначала она проверяет, содержится ли &ldquo;s&rdquo; в порядке кривой secp256k1. Если это не так, она увеличивает индекс публичного ключа Боба, чтобы получить другой общий секрет.</li><li>Во-вторых, она вычисляет публичный ключ &ldquo;K0&rdquo; путем сложения точек &ldquo;B&rdquo; и &ldquo;s·G&rdquo; на эллиптической кривой. Другими словами, Алиса добавляет публичный ключ, полученный из платежного кода Боба &ldquo;B&rdquo;, к другой точке, вычисленной на эллиптической кривой путем добавления и удвоения точек с общим секретом &ldquo;s&rdquo; из точки &ldquo;G&rdquo;, генерирующей кривую secp256k1. Эта новая точка представляет собой публичный ключ, и мы называем ее &ldquo;K0&rdquo;:</li></ul><pre tabindex=0><code>K0 = B + s·G
</code></pre><ul><li>С помощью этого публичного ключа &ldquo;K0&rdquo; Алиса может получить пустой адрес приема стандартным способом (например, SegWit V0 в Bech32).</li></ul><p>Получив адрес приема &ldquo;K0&rdquo;, принадлежащий Бобу, Алиса может провести классическую транзакцию Bitcoin, выбрав на другой ветке своего HD-кошелька принадлежащий ей UTXO и потратив его на адрес &ldquo;K0&rdquo; Боба.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1007.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Если сопоставить эту схему с тем, что я описал ранее, то:</p><ul><li>&ldquo;Child Priv-Key 0&rdquo; на стороне Алисы соответствует: <strong><em>a</em></strong>.</li><li>&ldquo;Child Pub-Key 0&rdquo; на стороне Боба соответствует: <strong><em>B</em></strong>.</li><li>&ldquo;Payment Secret 0&rdquo; соответствует: <strong><em>s</em></strong>.</li><li>&ldquo;Payment Pub-Key 0&rdquo; соответствует: <strong><em>K0</em></strong>.</li></ul><p>Я кратко изложу шаги, которые мы только что вместе прошли для отправки платежа BIP47:</p><ul><li>Алиса выбирает первый дочерний приватный ключ, полученный из ее персонального платежного кода.</li><li>Она вычисляет секретную точку на эллиптической кривой с помощью ECDH из первого неиспользованного дочернего публичного ключа, полученного из платежного кода Боба.</li><li>Она использует эту секретную точку для вычисления общего секрета с помощью SHA256.</li><li>Она использует этот общий секрет для вычисления новой секретной точки на эллиптической кривой.</li><li>Она добавляет эту новую секретную точку к публичному ключу Боба.</li><li>Она получает новый эфемерный публичный ключ, для которого только Боб имеет соответствующий приватный ключ.</li><li>Алиса может отправить классическую транзакцию Бобу на полученный эфемерный адрес приема.</li></ul><p>Если она хочет произвести второй платеж, то повторяет описанные выше действия, за исключением того, что выбирает второй публичный ключ, полученный из платежного кода Боба. Другими словами, следующий неиспользованный ключ. Тогда у нее появится второй адрес приема, принадлежащий Бобу &ldquo;K1&rdquo;.</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1008.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Она может продолжать в том же духе и вывести до 2^32 пустых адресов, принадлежащих Бобу.</p><p>С внешней точки зрения, наблюдая за блокчейном Bitcoin, теоретически невозможно отличить платеж BIP47 от традиционного платежа. Приведем <a href=https://blockstream.info/testnet/tx/94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254>пример платежной транзакции BIP47</a> в сети Testnet.</p><p>TXID:</p><pre tabindex=0><code>94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
</code></pre><p>Это выглядит как классическая транзакция с одним входом, платежным выходом в 210 000 сатоши и сдачей:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1009.png><p><em>Источник: <a href=https://blockstream.info/>https://blockstream.info/</a></em></p></div><h3 id=получение-платежа-bip47-и-выведение-приватного-ключа>Получение платежа BIP47 и выведение приватного ключа
<a class=anchor href=#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%b0-bip47-%d0%b8-%d0%b2%d1%8b%d0%b2%d0%b5%d0%b4%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d1%80%d0%b8%d0%b2%d0%b0%d1%82%d0%bd%d0%be%d0%b3%d0%be-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0>#</a></h3><p>Алиса только что произвела свой первый платеж на пустой адрес BIP47, принадлежащий Бобу. Теперь давайте рассмотрим, как Боб получает этот платеж. Мы также увидим, почему Алиса не имеет доступа к приватному ключу только что сгенерированного адреса и как Бобу найти этот ключ, чтобы потратить только что полученные биткоины.</p><p>Как только Боб получает от Алисы транзакцию-уведомление, он получает публичный ключ BIP47 &ldquo;K0&rdquo; еще до того, как его корреспондент отправил платеж. Поэтому он наблюдает любой платеж на связанный с ним адрес. Более того, он сразу же выведет несколько адресов, которые он будет наблюдать (K0, K1, K2, K3&mldr;). Вот как он получает этот публичный ключ &ldquo;K0&rdquo;:</p><ul><li>Боб выбирает первый дочерний приватный ключ, полученный из его платежного кода. Этот приватный ключ получил имя &ldquo;b&rdquo;. Он связан с публичным ключом &ldquo;B&rdquo;, с которым Алиса производила свои вычисления на <a href=/bip47-ili-gadkij-utenok/#%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d0%b0%d1%8f-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d1%8f-%d0%b2-%d1%80%d0%b0%d0%bc%d0%ba%d0%b0%d1%85-bip47>предыдущем шаге</a>:</li></ul><pre tabindex=0><code>b
</code></pre><ul><li>Боб выбирает первый публичный ключ Алисы, полученный из ее платежного кода. Этот ключ называется &ldquo;A&rdquo;. Он связан с приватным ключом &ldquo;a&rdquo;, с помощью которого Алиса производила свои расчеты и который известен только Алисе. Боб может выполнить этот процесс, поскольку ему известен платежный код Алисы, который был отправлен ему вместе с <a href=/bip47-ili-gadkij-utenok/#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d0%b8-%d1%83%d0%b2%d0%b5%d0%b4%d0%be%d0%bc%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f>транзакцией уведомления</a>.</li></ul><pre tabindex=0><code>A = a·G
</code></pre><ul><li>Боб вычисляет секретную точку &ldquo;S&rdquo; путем сложения и удвоения точек на эллиптической кривой, применяя свой приватный ключ &ldquo;b&rdquo; к публичному ключу Алисы &ldquo;A&rdquo;. Здесь мы видим использование ECDH, который гарантирует, что эта точка &ldquo;S&rdquo; будет одинаковой для Боба и Алисы.</li></ul><pre tabindex=0><code>S = b·A
</code></pre><ul><li>Так же, как и Алиса, Боб выделяет абсциссу этой точки &ldquo;S&rdquo;. Мы назвали это значение &ldquo;Sx&rdquo;. Он передает это значение функции SHA256 для нахождения общего секрета &ldquo;s&rdquo; (строчная буква).</li></ul><pre tabindex=0><code>s = SHA256(Sx)
</code></pre><ul><li>Точно так же, как и Алиса, Боб вычисляет точку &ldquo;s·G&rdquo; на эллиптической кривой. Затем он добавляет эту секретную точку к своему публичному ключу &ldquo;B&rdquo;. После этого он получает новую точку на эллиптической кривой, которую интерпретирует как публичный ключ &ldquo;K0&rdquo;:</li></ul><pre tabindex=0><code>K0 = B + s·G
</code></pre><p>Получив публичный ключ &ldquo;K0&rdquo;, Боб может получить соответствующий приватный ключ, чтобы потратить свои биткоины. Он единственный, кто может сгенерировать это число.</p><ul><li>Боб берет свой дочерний приватный ключ &ldquo;b&rdquo;, полученный из его персонального платежного кода. Только он один может получить значение &ldquo;b&rdquo;. Затем он добавляет &ldquo;b&rdquo; к общему секрету &ldquo;s&rdquo;, чтобы получить k0, приватный ключ K0:</li></ul><pre tabindex=0><code>k0 = b + s
</code></pre><p>Благодаря групповому закону эллиптической кривой Боб получает именно тот приватный ключ, который соответствует публичному ключу Алисы. Таким образом, мы имеем:</p><pre tabindex=0><code>K0 = k0·G
</code></pre><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1010.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Если сопоставить эту схему с тем, что я описал ранее, то:</p><ul><li>&ldquo;Child Priv-Key 0&rdquo; на стороне Боба соответствует: <strong>b</strong>.</li><li>&ldquo;Child Pub-Key 0&rdquo; на стороне Алисы соответствует: <strong>A</strong>.</li><li>&ldquo;Payment Secret 0&rdquo; соответствует: <strong>s</strong>.</li><li>&ldquo;Payment Pub-Key 0&rdquo; соответствует: <strong>K0</strong>.</li><li>&ldquo;Payment Priv-Key 0&rdquo; соответствует: <strong>k0</strong>.</li></ul><p>Я обобщу только что рассмотренные нами шаги по получению платежа BIP47 и вычислению соответствующего приватного ключа:</p><ul><li>Боб выбирает первый дочерний приватный ключ, полученный из его персонального платежного кода.</li><li>Он вычисляет секретную точку на эллиптической кривой с помощью ECDH из первого дочернего публичного ключа, полученного из кода цепочки (chain code) Алисы.</li><li>Он использует эту секретную точку для вычисления общего секрета с помощью SHA256.</li><li>Он использует этот общий секрет для вычисления новой секретной точки на эллиптической кривой.</li><li>Он добавляет эту новую секретную точку к своему личному публичному ключу.</li><li>Он получает новый эфемерный публичный ключ, на который Алиса отправит свой первый платеж.</li><li>Боб вычисляет приватный ключ, связанный с этим эфемерным публичным ключом, путем сложения своего дочернего приватного ключа, полученного из платежного кода, и общего секрета.</li></ul><p>Поскольку Алиса не может получить &ldquo;b&rdquo;, приватный ключ Боба, она не может определить k0, приватный ключ, связанный с адресом приема BIP47 Боба.</p><p>Схематически вычисление общего секрета &ldquo;S&rdquo; можно представить следующим образом:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1011.jpg></div><p>После того как общий секрет найден с помощью ECDH, Алиса и Боб вычисляют публичный ключ &ldquo;K0&rdquo; платежного адреса BIP47, а Боб также вычисляет связанный с ним приватный ключ &ldquo;k0&rdquo;:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1012.jpg></div><h3 id=возврат-платежа-bip47>Возврат платежа BIP47
<a class=anchor href=#%d0%b2%d0%be%d0%b7%d0%b2%d1%80%d0%b0%d1%82-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%b0-bip47>#</a></h3><p>Поскольку Боб знает многоразовый платежный код Алисы, у него уже есть вся необходимая информация для отправки ей возмещения. Ему не нужно будет снова связываться с Алисой, чтобы запросить какую-либо информацию. Ему достаточно уведомить ее транзакцией уведомления, в частности, для того, чтобы она могла получить свои адреса BIP47 со своим сидом, а затем он также может отправить ей до 2^32 платежей.</p><p>Затем Боб может отплатить Алисе тем же способом, каким она посылала ему платежи. Роли поменялись местами:</p><div class=imageWrapper><img src=/img/bip47-ili-gadkij-utenok/ugly-1013.png><p><em>Источник: <a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>Многоразовые платежные коды для иерархических детерминированных кошельков</a></em></p></div><p>Теперь вы знаете все тонкости этого великолепного решения, которым является BIP47.</p><h2 id=производное-применение-paynym>Производное применение PayNym
<a class=anchor href=#%d0%bf%d1%80%d0%be%d0%b8%d0%b7%d0%b2%d0%be%d0%b4%d0%bd%d0%be%d0%b5-%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5-paynym>#</a></h2><p>В результате реализации BIP47 в Samourai Wallet появились PayNym - идентификаторы, вычисляемые из платежных кодов пользователей. Сегодня их полезность выходит далеко за рамки использования BIP47.</p><p>Команда Samourai постепенно развивает целую экосистему инструментов и сервисов, основанных на PayNym пользователя. В их числе, конечно же, все инструменты проведения платежей для оптимизации конфиденциальности пользователя за счет добавления энтропии в транзакцию и, соответственно, правдоподобного отрицания.</p><p>Совместное использование Soroban, сети шифрованной связи на базе Tor, и PayNym позволило значительно оптимизировать работу пользователей при создании совместных транзакций, сохранив при этом высокий уровень безопасности. Транзакции Stowaway (PayJoin) и StonewallX2 могут быть легко осуществлены без необходимости вручную выполнять многочисленные обмены неподписанными транзакциями, необходимые для организации совместных транзакций такого типа.</p><p>В отличие от использования BIP47, поскольку для проведения этих совместных операций не требуется проведение уведомительной транзакции, для использования этих инструментов достаточно соединить (&ldquo;follow&rdquo;) PayNym. Подключать их не требуется.</p><p>В дополнение к этим совместным операциям мы недавно узнали, что команда Samourai работает над протоколом аутентификации, связанным с PayNym: Auth47. Этот инструмент уже реализован и может быть использован, например, для аутентификации с помощью PayNym на сайте, принимающем этот метод. В будущем, как мне кажется, помимо веб-аутентификации, Auth47 станет частью более глобального проекта, основанного на экосистеме BIP47/PayNym/Samourai. Возможно, этот протокол будет использоваться для дальнейшей оптимизации работы пользователей с кошельком Samourai, в частности, при использовании инструментов для расходования средств. Следите за новостями&mldr;</p><h2 id=мое-личное-мнение-о-bip47>Мое личное мнение о BIP47
<a class=anchor href=#%d0%bc%d0%be%d0%b5-%d0%bb%d0%b8%d1%87%d0%bd%d0%be%d0%b5-%d0%bc%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5-%d0%be-bip47>#</a></h2><p>Очевидно, что основным недостатком BIP47 является транзакция уведомления. Она приводит к тому, что пользователю приходится тратить деньги на ее майнинг, что для некоторых может быть раздражающим фактором. С другой стороны, аргумент о спаме подомными транзакциями в блокчейне Биткоина абсолютно неприемлем. Любой, кто платит деньги за транзакцию, должен иметь возможность зарегистрировать ее, с какой бы целью она ни проводилась. Утверждать обратное - значит поддерживать цензуру.</p><p>Возможно, в будущем будут найдены другие, менее затратные решения для передачи платежного кода отправителя получателю, чтобы тот мог надежно его хранить. Но на данный момент транзакция уведомления остается решением с наименьшими компромиссами.</p><p>При учете всех преимуществ BIP47 этот недостаток оказывается незначительным. Из всех существующих предложений по решению проблемы повторного использования адресов, на мой взгляд, это лучшее решение.</p><p>Как было сказано выше, большая часть повторного использования адресов происходит на биржах. BIP47 - единственное разумное решение, которое действительно решает эту проблему в корне. Любое предложение по сокращению повторного использования адресов должно учитывать этот аспект и ориентировать решение на основной источник проблемы.</p><p>С точки зрения использования, несмотря на достаточно сложный механизм работы, процедура оплаты BIP47 является детской забавой. Поэтому многоразовые платежные коды могут быть легко освоены даже начинающими пользователями.</p><p>С точки зрения конфиденциальности BIP47 очень интересен. Как я уже объяснял в разделе, посвященном <a href=/bip47-ili-gadkij-utenok/#%d1%82%d1%80%d0%b0%d0%bd%d0%b7%d0%b0%d0%ba%d1%86%d0%b8%d1%8f-%d1%83%d0%b2%d0%b5%d0%b4%d0%be%d0%bc%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f>транзакции уведомления</a>, платежный код не раскрывает никакой информации о полученных эфемерных адресах. Поэтому он позволяет прервать поток информации между Биткоин-транзакцией и идентификатором получателя, в отличие от традиционного использования адреса получения.</p><p>И самое главное - реализация BIP47 в виде PayNym работает! В кошельке Samourai она доступна с 2016 года, а в кошельке Sparrow - с начала этого года. Это не научный проект, а решение, которое было протестировано вчера и полностью работоспособно сегодня.</p><p>Будем надеяться, что в будущем эти многоразовые платежные коды будут приняты на вооружение игроками экосистемы, внедрены в программное обеспечение кошельков и будут использоваться биткоинерами.</p><p>Любое решение, действительно положительно влияющее на конфиденциальность пользователей, должно обсуждаться, продвигаться и защищаться, чтобы Биткоин не стал инструментом государственного надзора.</p><blockquote><p>Он был чересчур счастлив, но нисколько не возгордился — доброе сердце не знает гордости, — помня то время, когда все его презирали и гнали. А теперь все говорят, что он прекраснейший между прекрасными птицами! Сирень склоняла к нему в воду свои душистые ветви, солнышко светило так славно… И вот крылья его зашумели, стройная шея выпрямилась, а из груди вырвался ликующий крик:</p><p>— Мог ли я мечтать о таком счастье, когда был еще гадким утенком!</p></blockquote><hr><h3 id=внешние-источники-и-благодарности>Внешние источники и благодарности
<a class=anchor href=#%d0%b2%d0%bd%d0%b5%d1%88%d0%bd%d0%b8%d0%b5-%d0%b8%d1%81%d1%82%d0%be%d1%87%d0%bd%d0%b8%d0%ba%d0%b8-%d0%b8-%d0%b1%d0%bb%d0%b0%d0%b3%d0%be%d0%b4%d0%b0%d1%80%d0%bd%d0%be%d1%81%d1%82%d0%b8>#</a></h3><ul><li>Спасибо <a href=https://twitter.com/LaurentMT>LaurentMT</a> и <a href=https://twitter.com/TheoPantamis>Théo Pantamis</a> за множество объясненных ими концепций, которые я использовал в этой статье. Надеюсь, что мне удалось их точно передать.</li><li>Спасибо <a href=https://twitter.com/FanisMichalakis>Fanis Michalakis</a> за вычитку этого текста и экспертные советы.</li><li><a href=https://bitcoiner.guide/paynym/>https://bitcoiner.guide/paynym/</a></li><li><a href=https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki>https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki</a></li><li><a href=https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB_%D0%94%D0%B8%D1%84%D1%84%D0%B8_%E2%80%94_%D0%A5%D0%B5%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD%D0%B0>Википедия: Протокол Диффи — Хеллмана</a></li><li><a href=https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB_%D0%94%D0%B8%D1%84%D1%84%D0%B8_%E2%80%94_%D0%A5%D0%B5%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD%D0%B0_%D0%BD%D0%B0_%D1%8D%D0%BB%D0%BB%D0%B8%D0%BF%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85_%D0%BA%D1%80%D0%B8%D0%B2%D1%8B%D1%85>Википедия: Протокол Диффи — Хеллмана на эллиптических кривых</a></li><li><a href=https://security.stackexchange.com/questions/46802/what-is-the-difference-between-dhe-and-ecdh>https://security.stackexchange.com/questions/46802/what-is-the-difference-between-dhe-and-ecdh</a></li><li><a href="https://commandlinefanatic.com/cgi-bin/showarticle.cgi?article=art060">https://commandlinefanatic.com/cgi-bin/showarticle.cgi?article=art060</a></li><li><a href=https://ee.stanford.edu/~hellman/publications/24.pdf>https://ee.stanford.edu/~hellman/publications/24.pdf</a></li><li><a href=https://www.researchgate.net/publication/317339928_A_study_on_diffie-hellman_key_exchange_protocols>https://www.researchgate.net/publication/317339928_A_study_on_diffie-hellman_key_exchange_protocols</a></li></ul></article><hr><i>Connect to our relay to leave a comment. <a href=https://21ideas.org/en/comments/>Details</a>.<br>Подключитесь к нашему релею, чтобы оставить комментарий. <a href=https://21ideas.org/comments/>Подробнее</a>.</i>
<zap-threads anchor=https://21ideas.org/bip47-ili-gadkij-utenok/ author=npub1lm3f47nzyf0rjp6fsl4qlnkmzed4uj4h2gnf2vhe3l3mrj85vqks6z3c7l relays=wss://21ideas.nostr1.com disable=replyAnonymously legacy-url=true></zap-threads><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#проблема-повторного-использования-адресов>Проблема повторного использования адресов</a></li><li><a href=#принципы-работы-bip47-и-paynym>Принципы работы BIP47 и PayNym</a></li><li><a href=#руководство-использование-paynym>Руководство: использование PayNym</a><ul><li><a href=#создание-транзакции-bip47-с-помощью-samourai-wallet>Создание транзакции BIP47 с помощью Samourai Wallet</a></li><li><a href=#создание-транзакции-bip47-с-помощью-sparrow-wallet>Создание транзакции BIP47 с помощью Sparrow Wallet</a></li></ul></li><li><a href=#как-работает-bip47>Как работает BIP47</a><ul><li><a href=#многоразовый-платежный-код>Многоразовый платежный код</a></li><li><a href=#криптографический-протокол-обмен-ключами-диффи-хеллмана-на-эллиптических-кривых-ecdh>Криптографический протокол: обмен ключами Диффи-Хеллмана на эллиптических кривых (ECDH)</a></li><li><a href=#транзакция-уведомления>Транзакция уведомления</a></li><li><a href=#построение-транзакции-уведомления>Построение транзакции уведомления</a></li><li><a href=#получение-транзакции-уведомления>Получение транзакции уведомления</a></li><li><a href=#платежная-транзакция-в-рамках-bip47>Платежная транзакция в рамках BIP47</a></li><li><a href=#получение-платежа-bip47-и-выведение-приватного-ключа>Получение платежа BIP47 и выведение приватного ключа</a></li><li><a href=#возврат-платежа-bip47>Возврат платежа BIP47</a></li></ul></li><li><a href=#производное-применение-paynym>Производное применение PayNym</a></li><li><a href=#мое-личное-мнение-о-bip47>Мое личное мнение о BIP47</a><ul><li><a href=#внешние-источники-и-благодарности>Внешние источники и благодарности</a></li></ul></li></ul></li></ul></nav></div></aside></main><script src=/static/scripts.js></script></body></html>